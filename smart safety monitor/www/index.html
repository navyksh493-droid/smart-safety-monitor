<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ìŠ¤ë§ˆíŠ¸ ì•ˆì „ ê´€ì œ (Hybrid v9.70)</title>
    
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#1e3a8a">
    <link rel="icon" id="favicon" href="">

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

    <style>
        body { font-family: 'Noto Sans KR', sans-serif; user-select: none; }
        .map-container { height: 100vh; width: 100%; z-index: 10; }
        .sos-btn { 
            position: absolute; bottom: 90px; right: 20px; z-index: 1000; 
            width: 68px; height: 68px; border-radius: 50%; 
            background: linear-gradient(135deg, #ef4444, #b91c1c); 
            color: white; display: flex; flex-direction: column; 
            align-items: center; justify-content: center; 
            font-weight: bold; font-size: 11px;
            box-shadow: 0 4px 20px rgba(220, 38, 38, 0.6); 
            border: 3px solid white; animation: pulse-sos 2s infinite;
        }
        @keyframes pulse-sos { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        .sos-btn:active { transform: scale(0.95); }
        
        /* ë°±ê·¸ë¼ìš´ë“œ ìƒì¡´ìš© (íˆ¬ëª… ë¹„ë””ì˜¤) */
        #keep-alive-video { position: absolute; top: 0; left: 0; width: 1px; height: 1px; opacity: 0.01; pointer-events: none; }
    </style>
</head>
<body class="bg-gray-100 overflow-hidden h-screen w-screen">

    <video id="keep-alive-video" playsinline muted loop>
        <source src="data:video/mp4;base64,AAAAHGZ0eXBpc29tAAACAGlzb21pc28yYXZjMQAAAAhmcmVlAAACQm1kYXQAAAGzABAHAAABthADAQAAAB5lbHN0AAAAAAAAAAEAAAABAAAAAAABAAAAAAABAAAAAAOBbW9vdgAAAGxtdmhkAAAAAAAAGNQAABjUAAABAAABAAAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAgAAAAh0cmFrAAAAXHRraGQAAAADAAAAGNQAABjUAAAAAQAAAAABAAAAAAAAAAAAAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABAAAAAAIAAAAkZWR0cwAAABxlbHN0AAAAAAAAAAEAAAABAAAAAAABAAAAAAABAAAAAAOibWRpYQAAACBtZGhkAAAAABjUAAAY1AAAAQAAAQAAAAABAFgAAAAAAAhWhGRscgAAAAAAAAAAbWluZgAAABR2bWhkAAAAAQAAAAAAAAAAAAAAJGRpbmYAAAAcZHJlZgAAAAAAAAABAAAADHVybCAAAAABAAADWnN0YmwAAAB5c3RzZAAAAAAAAAABAAAAiWF2YzEAAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAEAAQABAAAAAAABAAAAAAAAAAAAAAABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAGP//AAAALWF2Y0MBWQAa//8AAAAuZ2RrdRWbCAoBwQAAA+gA8F2D3awEBAQAAAAEAAAAAAQAAAAEAAAACHN0dHMAAAAAAAAAAQAAAAEAAAB4Y3R0cwAAAAAAAAAAAAABAAEAAAAcY3R0cwAAAAAAAAAAAAABAAEAAAAcc3RzYwAAAAAAAAABAAAAAQAAAAEAAAABAAAAFHN6LmEAAAAAAAAAAQAAAAQAAAA0c3RjbwAAAAAAAAABAAAAAAA=" type="video/mp4">
    </video>

    <div id="auth-screen" class="fixed inset-0 z-50 flex items-center justify-center bg-gray-900 bg-opacity-90">
        <div class="bg-white p-8 rounded-lg shadow-2xl w-full max-w-md m-4 relative">
            <div class="text-center mb-8">
                <div class="bg-blue-900 w-16 h-16 rounded-2xl mx-auto mb-4 flex items-center justify-center shadow-lg">
                    <i class="fa-solid fa-satellite-dish text-white text-3xl animate-pulse"></i>
                </div>
                <h1 class="text-2xl font-bold text-gray-800">ìŠ¤ë§ˆíŠ¸ ì•ˆì „ ê´€ì œ</h1>
                <p class="text-sm text-gray-500">Hybrid GPS System v9.70</p>
                <div id="status-bar" class="mt-4 bg-gray-100 rounded-full py-1 px-3 text-xs font-bold text-gray-500 flex justify-center items-center gap-2">
                    <span id="conn-icon" class="w-2 h-2 rounded-full bg-gray-400"></span>
                    <span id="conn-text">ì„œë²„ ì—°ê²° ëŒ€ê¸° ì¤‘...</span>
                </div>
            </div>

            <div id="form-login" class="space-y-4">
                <input type="text" id="login-id" placeholder="ì•„ì´ë””" class="w-full border p-3 rounded-lg bg-gray-50 focus:bg-white focus:ring-2 focus:ring-blue-900 transition outline-none">
                <div class="relative">
                    <input type="password" id="login-pw" placeholder="ë¹„ë°€ë²ˆí˜¸" class="w-full border p-3 rounded-lg bg-gray-50 focus:bg-white focus:ring-2 focus:ring-blue-900 transition outline-none">
                    <button id="btn-show-pw" class="absolute right-3 top-3.5 text-gray-400 hover:text-blue-900"><i class="fa-solid fa-eye"></i></button>
                </div>
                <div class="flex items-center gap-2 pt-1">
                    <input type="checkbox" id="auto-login-check" class="w-4 h-4 rounded text-blue-900 accent-blue-900">
                    <label for="auto-login-check" class="text-sm text-gray-600">ìë™ ë¡œê·¸ì¸</label>
                </div>
                <button id="btn-login" class="w-full bg-blue-900 text-white py-4 rounded-lg font-bold shadow-lg hover:bg-blue-800 transition transform active:scale-95 flex justify-center items-center gap-2">
                    <span>ê´€ì œ ì‹œì‘</span> <i class="fa-solid fa-arrow-right"></i>
                </button>
                <div class="text-center mt-4">
                    <button id="btn-to-signup" class="text-sm text-gray-500 hover:text-blue-900 underline">ìƒˆ ê³„ì • ë§Œë“¤ê¸°</button>
                </div>
            </div>

            <div id="form-signup" class="space-y-4 hidden">
                <input type="text" id="reg-id" placeholder="ì•„ì´ë”” (ì˜ë¬¸/ìˆ«ì)" class="w-full border p-3 rounded-lg">
                <input type="text" id="reg-name" placeholder="ì´ë¦„ (ì‹¤ëª…)" class="w-full border p-3 rounded-lg">
                <input type="password" id="reg-pw" placeholder="ë¹„ë°€ë²ˆí˜¸" class="w-full border p-3 rounded-lg">
                <div class="border p-2 rounded-lg bg-gray-50">
                    <label class="text-xs font-bold text-gray-500 pl-1">ì†Œì† í˜„ì¥</label>
                    <select id="reg-site" class="w-full border p-2 rounded bg-white mt-1"></select>
                </div>
                <select id="reg-role" class="w-full border p-3 rounded-lg bg-white">
                    <option value="worker">ê·¼ë¡œì</option>
                    <option value="admin">í˜„ì¥ì†Œì¥ (ê´€ë¦¬ì)</option>
                    <option value="safety">ì•ˆì „ê´€ë¦¬ì</option>
                </select>
                <button id="btn-signup" class="w-full bg-green-600 text-white py-4 rounded-lg font-bold shadow-lg hover:bg-green-700 transition">ê°€ì… ì‹ ì²­ ì™„ë£Œ</button>
                <button id="btn-to-login" class="w-full bg-gray-200 text-gray-600 py-3 rounded-lg font-bold mt-2 hover:bg-gray-300">ì·¨ì†Œ</button>
            </div>
        </div>
    </div>

    <div id="main-dashboard" class="hidden h-screen flex flex-col">
        <div class="bg-white px-4 py-3 flex justify-between items-center shadow-md z-20">
            <div class="flex items-center gap-3">
                <div class="bg-blue-900 w-9 h-9 rounded-lg flex items-center justify-center text-white shadow"><i class="fa-solid fa-tower-broadcast"></i></div>
                <div>
                    <h1 class="font-bold text-gray-800 text-sm leading-tight">í†µí•© ê´€ì œì‹¤</h1>
                    <div class="flex items-center gap-1">
                        <span class="w-1.5 h-1.5 rounded-full bg-green-500"></span>
                        <p id="user-display" class="text-[10px] text-gray-500">ì ‘ì† í™•ì¸ ì¤‘...</p>
                    </div>
                </div>
            </div>
            <button onclick="logout()" class="text-xs border border-gray-300 text-gray-600 px-3 py-2 rounded-lg hover:bg-gray-50 font-bold transition">
                ë¡œê·¸ì•„ì›ƒ
            </button>
        </div>

        <div class="flex-1 relative bg-gray-200">
            <div id="map" class="h-full w-full outline-none"></div>
            
            <div class="absolute top-4 left-4 right-4 z-[500] flex flex-col gap-2 pointer-events-none">
                <div class="bg-white/95 backdrop-blur px-4 py-3 rounded-xl shadow-lg border border-blue-50 flex justify-between items-center">
                    <div class="flex items-center gap-3">
                        <div id="gps-pulse" class="w-3 h-3 rounded-full bg-gray-300"></div>
                        <div class="flex flex-col">
                            <span class="text-[10px] font-bold text-gray-400 uppercase tracking-wider">Signal Status</span>
                            <span id="gps-status-text" class="text-xs font-bold text-gray-600">ìœ„ì¹˜ íƒìƒ‰ ì¤‘...</span>
                        </div>
                    </div>
                    <div class="text-right">
                        <span id="gps-acc" class="text-lg font-black text-blue-900 font-mono">--</span>
                        <span class="text-[10px] text-gray-400">m ì˜¤ì°¨</span>
                    </div>
                </div>
                
                <div id="bg-mode-badge" class="hidden self-center bg-black/70 text-white text-[10px] px-3 py-1 rounded-full backdrop-blur flex items-center gap-2">
                    <i class="fa-solid fa-moon text-yellow-400"></i> ëŒ€ê¸°ëª¨ë“œ ë°©ì–´ ì‘ë™ ì¤‘
                </div>
            </div>

            <button onclick="triggerSOS()" class="sos-btn">
                <i class="fa-solid fa-bell fa-xl mb-1"></i>
                SOS
            </button>
        </div>
    </div>

    <script>
        // === 1. ì‹œìŠ¤í…œ ì„¤ì • ===
        const firebaseConfig = {
            apiKey: "AIzaSyCMWQa-O2m8BB0XHzhXlYfdy3smIsgKs0A",
            authDomain: "smart-safety-monitor-37649.firebaseapp.com",
            projectId: "smart-safety-monitor-37649",
            storageBucket: "smart-safety-monitor-37649.firebasestorage.app",
            messagingSenderId: "409985776476",
            appId: "1:409985776476:web:a36b3b93e734878fb35f99",
            measurementId: "G-E73V9VHXR3"
        };

        let app, auth, db;
        const appId = "default-app-id";
        let map, currentUser = null;
        let markers = {}; 
        let watchId = null;
        let wakeLock = null; // í™”ë©´ êº¼ì§ ë°©ì§€ìš©
        let lastPositionTime = 0; // GPS ê°ì‹œìš©

        // í˜ì´ì§€ ë¡œë“œ
        window.addEventListener('load', () => {
            initSystem();
        });

        async function initSystem() {
            try {
                app = firebase.initializeApp(firebaseConfig);
                auth = firebase.auth();
                db = firebase.firestore();
                
                // ë„¤íŠ¸ì›Œí¬ í´ë§ ê°•ì œ ì„¤ì • (ì—°ê²° ëŠê¹€ ë°©ì§€)
                db.settings({ experimentalForceLongPolling: true, merge: true });

                updateStatus("online", "ì„œë²„ ì—°ê²° ì™„ë£Œ");
                loadSites(); // í˜„ì¥ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°

                // ìë™ ë¡œê·¸ì¸
                const saved = localStorage.getItem('savedUser');
                if(saved) {
                    try { currentUser = JSON.parse(saved); startSession(); } catch(e){}
                }
            } catch (e) {
                updateStatus("error", "ì—°ê²° ì‹¤íŒ¨: " + e.message);
            }
            setupUI();
        }

        // ìƒíƒœ í‘œì‹œì¤„ ì—…ë°ì´íŠ¸
        function updateStatus(state, msg) {
            const icon = document.getElementById('conn-icon');
            const text = document.getElementById('conn-text');
            text.innerText = msg;
            
            if(state === 'online') {
                icon.className = "w-2 h-2 rounded-full bg-green-500 animate-pulse";
                text.className = "text-green-600";
            } else if (state === 'error') {
                icon.className = "w-2 h-2 rounded-full bg-red-500";
                text.className = "text-red-500";
            } else {
                icon.className = "w-2 h-2 rounded-full bg-gray-400";
            }
        }

        function setupUI() {
            // í™”ë©´ ì „í™˜
            const showLogin = () => {
                document.getElementById('form-login').classList.remove('hidden');
                document.getElementById('form-signup').classList.add('hidden');
                document.getElementById('tab-login').classList.add('text-blue-900', 'border-blue-900');
                document.getElementById('tab-login').classList.remove('text-gray-400');
                document.getElementById('tab-signup').classList.remove('text-blue-900', 'border-blue-900');
                document.getElementById('tab-signup').classList.add('text-gray-400');
            };
            const showSignup = () => {
                document.getElementById('form-login').classList.add('hidden');
                document.getElementById('form-signup').classList.remove('hidden');
                document.getElementById('tab-signup').classList.add('text-blue-900', 'border-blue-900');
                document.getElementById('tab-signup').classList.remove('text-gray-400');
                document.getElementById('tab-login').classList.remove('text-blue-900', 'border-blue-900');
                document.getElementById('tab-login').classList.add('text-gray-400');
            };

            document.getElementById('tab-login').onclick = showLogin;
            document.getElementById('tab-signup').onclick = showSignup;
            document.getElementById('btn-to-signup').onclick = showSignup;
            document.getElementById('btn-to-login').onclick = showLogin;

            // ë¹„ë°€ë²ˆí˜¸ í† ê¸€
            document.getElementById('btn-show-pw').onclick = () => {
                const pw = document.getElementById('login-pw');
                pw.type = pw.type === 'password' ? 'text' : 'password';
            };

            document.getElementById('btn-login').onclick = handleLogin;
            document.getElementById('btn-signup').onclick = handleSignup;
        }

        // === 2. í•µì‹¬: í•˜ì´ë¸Œë¦¬ë“œ & ë°±ê·¸ë¼ìš´ë“œ GPS ë¡œì§ ===
        async function startSession() {
            document.getElementById('auth-screen').classList.add('hidden');
            document.getElementById('main-dashboard').classList.remove('hidden');
            document.getElementById('user-display').innerText = `${currentUser.name} (${currentUser.role === 'worker' ? 'ê·¼ë¡œì' : 'ê´€ë¦¬ì'})`;

            // ì§€ë„ ë¡œë“œ
            if(!map) {
                map = L.map('map', {zoomControl: false}).setView([37.5665, 126.9780], 15);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
            }

            // [ì¤‘ìš”] 1. ì¢€ë¹„ ëª¨ë“œ ì‹¤í–‰ (í™”ë©´ êº¼ì§ ë°©ì§€)
            activateKeepAlive();

            // [ì¤‘ìš”] 2. GPS ì‹œì‘
            startHybridGPS();

            // ë™ë£Œ ìœ„ì¹˜ êµ¬ë…
            subscribeWorkers();
        }

        // **ì¢€ë¹„ ëª¨ë“œ: í™”ë©´ì´ êº¼ì ¸ë„ ë¸Œë¼ìš°ì €ë¥¼ ê°•ì œë¡œ ê¹¨ì›€**
        async function activateKeepAlive() {
            try {
                // 1. ë¹„ë””ì˜¤ ì¬ìƒ (CPU í™œì„± ìœ ì§€)
                const video = document.getElementById('keep-alive-video');
                video.play().then(() => {
                    console.log("ë°±ê·¸ë¼ìš´ë“œ ë¹„ë””ì˜¤ ì¬ìƒ ì¤‘");
                }).catch(e => console.log("ë¹„ë””ì˜¤ ìë™ì¬ìƒ ì°¨ë‹¨ë¨ (í„°ì¹˜ í•„ìš”)"));

                // 2. Wake Lock API (í™”ë©´ ì–´ë‘¡ê²Œ ìœ ì§€)
                if ('wakeLock' in navigator) {
                    wakeLock = await navigator.wakeLock.request('screen');
                    document.getElementById('bg-mode-badge').classList.remove('hidden');
                    console.log("Wake Lock í™œì„±í™”ë¨");
                    
                    // í’€ë¦¬ë©´ ë‹¤ì‹œ ìš”ì²­
                    wakeLock.addEventListener('release', () => {
                        console.log('Wake Lock í’€ë¦¼, ì¬ìš”ì²­');
                        activateKeepAlive();
                    });
                }
            } catch (err) {
                console.log(`Wake Lock ì‹¤íŒ¨: ${err.name}, ${err.message}`);
            }
        }

        function startHybridGPS() {
            const options = { enableHighAccuracy: true, timeout: 20000, maximumAge: 0 };
            
            // GPS ê°ì‹œ ì‹œì‘
            watchId = navigator.geolocation.watchPosition(
                handlePositionSuccess,
                handlePositionError,
                options
            );

            // [ê°ì‹œê²¬] 15ì´ˆ ë™ì•ˆ ìœ„ì¹˜ ì—…ë°ì´íŠ¸ê°€ ì—†ìœ¼ë©´ GPS ì¬ì‹œì‘ (ëŠê¹€ ë°©ì§€)
            setInterval(() => {
                const now = Date.now();
                if (now - lastPositionTime > 15000) {
                    console.log("GPS ì‹ í˜¸ ë‘ì ˆ! ì¬ì—°ê²° ì‹œë„...");
                    navigator.geolocation.getCurrentPosition(handlePositionSuccess, handlePositionError, options);
                }
            }, 15000);
        }

        function handlePositionSuccess(pos) {
            lastPositionTime = Date.now(); // ë§ˆì§€ë§‰ ì‹ í˜¸ ì‹œê°„ ê°±ì‹ 
            const { latitude, longitude, accuracy } = pos.coords;

            // UI ê°±ì‹ 
            const pulse = document.getElementById('gps-pulse');
            const status = document.getElementById('gps-status-text');
            const acc = document.getElementById('gps-acc');

            pulse.className = "w-3 h-3 rounded-full bg-green-500 animate-ping";
            status.innerText = "ìœ„ì¹˜ ìˆ˜ì‹  ì¤‘ (ì •ìƒ)";
            status.className = "text-xs font-bold text-green-600";
            acc.innerText = Math.round(accuracy);

            // ë‚´ ìœ„ì¹˜ ì§€ë„ í‘œì‹œ
            if(map) {
                // map.panTo([latitude, longitude]); // ë„ˆë¬´ ìì£¼ ì›€ì§ì´ë©´ ë¶ˆí¸í•  ìˆ˜ ìˆì–´ ì œê±°í•˜ê±°ë‚˜ ì¡°ê±´ë¶€ ì‚¬ìš©
                if(markers['me']) map.removeLayer(markers['me']);
                markers['me'] = L.circleMarker([latitude, longitude], {
                    radius: 8, color: '#1e3a8a', fillOpacity: 0.9, weight: 3, fillColor: '#3b82f6'
                }).addTo(map);
            }

            // ì„œë²„ ì „ì†¡
            updateMyPosition(latitude, longitude);
        }

        function handlePositionError(err) {
            console.warn(`GPS ì—ëŸ¬: ${err.message}`);
            const status = document.getElementById('gps-status-text');
            const pulse = document.getElementById('gps-pulse');
            
            status.innerText = "ì‹ í˜¸ ì•½í•¨ / ì¬ê²€ìƒ‰...";
            status.className = "text-xs font-bold text-red-500";
            pulse.className = "w-3 h-3 rounded-full bg-red-500";
        }

        // === 3. ë°ì´í„°ë² ì´ìŠ¤ ë¡œì§ ===
        async function handleLogin() {
            const id = document.getElementById('login-id').value;
            const pw = document.getElementById('login-pw').value;
            
            if(!id || !pw) return alert("ì •ë³´ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
            
            try {
                if (!auth.currentUser) await auth.signInAnonymously();

                // ê´€ë¦¬ì ìë™ìƒì„±
                if(id === 'dark584' && pw === 'Rufghs0423!!') {
                    const check = await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('users').where('id', '==', 'dark584').get();
                    if(check.empty) {
                        await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('users').add({
                            id: 'dark584', pw: 'Rufghs0423!!', name: 'ìµœê³  ê´€ë¦¬ì', role: 'super_admin', approved: true, siteId: 'all'
                        });
                    }
                }

                const snapshot = await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('users')
                    .where('id', '==', id).where('pw', '==', pw).get();

                if (snapshot.empty) return alert("ê³„ì • ì •ë³´ê°€ í‹€ë¦½ë‹ˆë‹¤.");

                const userData = snapshot.docs[0].data();
                userData.docId = snapshot.docs[0].id;

                if (!userData.approved) return alert("ìŠ¹ì¸ ëŒ€ê¸° ì¤‘ì…ë‹ˆë‹¤.");

                currentUser = userData;
                if(document.getElementById('auto-login-check').checked) {
                    localStorage.setItem('savedUser', JSON.stringify(currentUser));
                }
                startSession();

            } catch (error) {
                alert("ë¡œê·¸ì¸ ì‹¤íŒ¨: " + error.message);
            }
        }

        async function handleSignup() {
            const id = document.getElementById('reg-id').value;
            const name = document.getElementById('reg-name').value;
            const pw = document.getElementById('reg-pw').value;
            const siteId = document.getElementById('reg-site').value;
            const role = document.getElementById('reg-role').value;

            if(!id || !name || !pw) return alert("ì •ë³´ë¥¼ ëª¨ë‘ ì…ë ¥í•˜ì„¸ìš”.");

            try {
                if (!auth.currentUser) await auth.signInAnonymously();
                const check = await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('users').where('id', '==', id).get();
                if(!check.empty) return alert("ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì•„ì´ë””ì…ë‹ˆë‹¤.");

                await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('users').add({
                    id, name, pw, siteId, role, approved: false, createdAt: Date.now()
                });
                alert("ê°€ì… ì‹ ì²­ ì™„ë£Œ!");
                document.getElementById('btn-to-login').click();
            } catch (e) { alert("ì˜¤ë¥˜: " + e.message); }
        }

        async function updateMyPosition(lat, lng) {
            if(!currentUser || !db) return;
            await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('workers').doc(currentUser.id).set({
                name: currentUser.name, role: currentUser.role, siteId: currentUser.siteId,
                lat: lat, lng: lng, lastUpdate: Date.now(), isVisible: true
            }, { merge: true });
        }

        function subscribeWorkers() {
            if (!db) return;
            let query = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('workers');
            if(currentUser.siteId !== 'all') query = query.where('siteId', '==', currentUser.siteId);

            query.onSnapshot((snapshot) => {
                snapshot.forEach(doc => {
                    const data = doc.data();
                    if(data.id === currentUser.id) return;
                    
                    // 5ë¶„ ì´ìƒ ë©ˆì¶˜ ì‚¬ëŒì€ ì§€ë„ì—ì„œ ì§€ìš°ê¸° (ì„ íƒì‚¬í•­)
                    if(Date.now() - data.lastUpdate > 300000) {
                        if(markers[doc.id]) map.removeLayer(markers[doc.id]);
                        return;
                    }

                    if(markers[doc.id]) map.removeLayer(markers[doc.id]);
                    
                    const color = data.isSOS ? '#ef4444' : '#3b82f6';
                    const marker = L.circleMarker([data.lat, data.lng], {
                        radius: data.isSOS ? 12 : 6, color: color, fillColor: color, fillOpacity: 0.8
                    }).addTo(map).bindPopup(`<b>${data.name}</b><br>${data.role}`);
                    
                    markers[doc.id] = marker;

                    if(data.isSOS && currentUser.role !== 'worker') {
                        // ê´€ë¦¬ìì—ê²ŒëŠ” ì†Œë¦¬ ì•Œë¦¼ ì¶”ê°€ ê°€ëŠ¥
                        alert(`ğŸš¨ êµ¬ì¡° ìš”ì²­! ${data.name}`);
                    }
                });
            });
        }

        function loadSites() {
            try {
                if (!auth.currentUser) auth.signInAnonymously();
                db.collection('artifacts').doc(appId).collection('public').doc('data').collection('sites').onSnapshot(snap => {
                    const sel = document.getElementById('reg-site');
                    sel.innerHTML = '';
                    snap.forEach(doc => {
                        sel.innerHTML += `<option value="${doc.id}">${doc.data().name}</option>`;
                    });
                    if(sel.innerHTML === '') sel.innerHTML = '<option value="default">ê¸°ë³¸ í˜„ì¥</option>';
                });
            } catch(e) {}
        }

        window.logout = function() { localStorage.removeItem('savedUser'); location.reload(); };
        window.triggerSOS = function() {
            if(currentUser && db && confirm("ğŸš¨ ê¸´ê¸‰ êµ¬ì¡° ìš”ì²­ì„ ë³´ëƒ…ë‹ˆê¹Œ?")) {
                db.collection('artifacts').doc(appId).collection('public').doc('data').collection('workers').doc(currentUser.id).set({ isSOS: true }, { merge: true });
                alert("êµ¬ì¡° ìš”ì²­ ì „ì†¡ ì™„ë£Œ!");
            }
        };
    </script>
</body>
</html>