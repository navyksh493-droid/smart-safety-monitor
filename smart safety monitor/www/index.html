<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ìŠ¤ë§ˆíŠ¸ ì•ˆì „ ê´€ì œ (Integrated v9.80)</title>
    
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#1e3a8a">
    <link rel="icon" id="favicon" href="">

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

    <style>
        body { font-family: 'Noto Sans KR', sans-serif; user-select: none; }
        .map-container { height: 100vh; width: 100%; z-index: 10; }
        
        /* SOS ë²„íŠ¼ ë””ìì¸ ë³µêµ¬ */
        .sos-btn { 
            position: absolute; bottom: 100px; right: 20px; z-index: 1000; 
            width: 70px; height: 70px; border-radius: 50%; 
            background: linear-gradient(135deg, #ef4444, #991b1b); 
            color: white; display: flex; flex-direction: column; 
            align-items: center; justify-content: center; 
            font-weight: bold; font-size: 14px;
            box-shadow: 0 4px 20px rgba(220, 38, 38, 0.7); 
            border: 3px solid white; animation: pulse-sos 2s infinite;
        }
        @keyframes pulse-sos { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
        .sos-btn:active { transform: scale(0.95); }

        /* í†µê³„ íŒ¨ë„ ë””ìì¸ */
        .stats-panel {
            position: absolute; top: 10px; left: 10px; right: 10px; z-index: 1000;
            background: rgba(255, 255, 255, 0.95); border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1); padding: 10px;
            display: flex; justify-content: space-around; text-align: center;
            backdrop-filter: blur(5px);
        }
        .stat-item .label { font-size: 10px; color: #666; font-weight: bold; }
        .stat-item .value { font-size: 16px; font-weight: 800; color: #1e3a8a; }
        .stat-item.danger .value { color: #ef4444; animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0.5; } }

        /* ë°±ê·¸ë¼ìš´ë“œ ìœ ì§€ìš© */
        #keep-alive-video { position: absolute; top: 0; left: 0; width: 1px; height: 1px; opacity: 0.01; pointer-events: none; }
    </style>
</head>
<body class="bg-gray-100 overflow-hidden h-screen w-screen">

    <video id="keep-alive-video" playsinline muted loop>
        <source src="data:video/mp4;base64,AAAAHGZ0eXBpc29tAAACAGlzb21pc28yYXZjMQAAAAhmcmVlAAACQm1kYXQAAAGzABAHAAABthADAQAAAB5lbHN0AAAAAAAAAAEAAAABAAAAAAABAAAAAAABAAAAAAOBbW9vdgAAAGxtdmhkAAAAAAAAGNQAABjUAAABAAABAAAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAgAAAAh0cmFrAAAAXHRraGQAAAADAAAAGNQAABjUAAAAAQAAAAABAAAAAAAAAAAAAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABAAAAAAIAAAAkZWR0cwAAABxlbHN0AAAAAAAAAAEAAAABAAAAAAABAAAAAAABAAAAAAOibWRpYQAAACBtZGhkAAAAABjUAAAY1AAAAQAAAQAAAAABAFgAAAAAAAhWhGRscgAAAAAAAAAAbWluZgAAABR2bWhkAAAAAQAAAAAAAAAAAAAAJGRpbmYAAAAcZHJlZgAAAAAAAAABAAAADHVybCAAAAABAAADWnN0YmwAAAB5c3RzZAAAAAAAAAABAAAAiWF2YzEAAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAEAAQABAAAAAAABAAAAAAAAAAAAAAABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAGP//AAAALWF2Y0MBWQAa//8AAAAuZ2RrdRWbCAoBwQAAA+gA8F2D3awEBAQAAAAEAAAAAAQAAAAEAAAACHN0dHMAAAAAAAAAAQAAAAEAAAB4Y3R0cwAAAAAAAAAAAAABAAEAAAAcY3R0cwAAAAAAAAAAAAABAAEAAAAcc3RzYwAAAAAAAAABAAAAAQAAAAEAAAABAAAAFHN6LmEAAAAAAAAAAQAAAAQAAAA0c3RjbwAAAAAAAAABAAAAAAA=" type="video/mp4">
    </video>

    <div id="auth-screen" class="fixed inset-0 z-50 flex items-center justify-center bg-gray-900 bg-opacity-90">
        <div class="bg-white p-8 rounded-lg shadow-2xl w-full max-w-md m-4 relative">
            <div class="text-center mb-8">
                <div class="bg-blue-900 w-16 h-16 rounded-2xl mx-auto mb-4 flex items-center justify-center shadow-lg">
                    <i class="fa-solid fa-helmet-safety text-white text-3xl"></i>
                </div>
                <h1 class="text-2xl font-bold text-gray-800">ìŠ¤ë§ˆíŠ¸ ì•ˆì „ ê´€ì œ</h1>
                <p class="text-sm text-gray-500">Integrated System v9.80</p>
                <p id="system-status" class="text-xs text-green-600 mt-2 font-bold">â— ì„œë²„ ë° GPS ëŒ€ê¸° ì¤‘</p>
            </div>

            <div class="flex border-b mb-6">
                <button id="tab-login" class="flex-1 py-3 font-bold text-blue-900 border-b-2 border-blue-900">ë¡œê·¸ì¸</button>
                <button id="tab-signup" class="flex-1 py-3 text-gray-400 hover:text-gray-600">íšŒì›ê°€ì…</button>
            </div>

            <div id="form-login" class="space-y-4">
                <input type="text" id="login-id" placeholder="ì•„ì´ë””" class="w-full border p-3 rounded-lg">
                <div class="relative">
                    <input type="password" id="login-pw" placeholder="ë¹„ë°€ë²ˆí˜¸" class="w-full border p-3 rounded-lg">
                    <button id="btn-show-pw" class="absolute right-3 top-3.5 text-gray-400"><i class="fa-solid fa-eye"></i></button>
                </div>
                <div class="flex items-center gap-2 pt-2">
                    <input type="checkbox" id="auto-login-check" class="w-4 h-4 rounded">
                    <label for="auto-login-check" class="text-sm text-gray-600">ìë™ ë¡œê·¸ì¸</label>
                </div>
                <button id="btn-login" onclick="handleLogin()" class="w-full bg-blue-900 text-white py-4 rounded-lg font-bold shadow-lg hover:bg-blue-800 transition">
                    ì‹œìŠ¤í…œ ì ‘ì†
                </button>
            </div>

            <div id="form-signup" class="space-y-4 hidden">
                <input type="text" id="reg-id" placeholder="ì•„ì´ë””" class="w-full border p-3 rounded-lg">
                <input type="text" id="reg-name" placeholder="ì´ë¦„ (ì‹¤ëª…)" class="w-full border p-3 rounded-lg">
                <input type="password" id="reg-pw" placeholder="ë¹„ë°€ë²ˆí˜¸" class="w-full border p-3 rounded-lg">
                <div class="border p-2 rounded-lg bg-gray-50">
                    <label class="text-xs font-bold text-gray-500 pl-1">í˜„ì¥ ì„ íƒ</label>
                    <select id="reg-site" class="w-full border p-2 rounded bg-white mt-1"></select>
                </div>
                <select id="reg-role" class="w-full border p-3 rounded-lg bg-white">
                    <option value="worker">ê·¼ë¡œì</option>
                    <option value="admin">í˜„ì¥ì†Œì¥ (ê´€ë¦¬ì)</option>
                    <option value="safety">ì•ˆì „ê´€ë¦¬ì</option>
                </select>
                <button id="btn-signup" onclick="handleSignup()" class="w-full bg-green-600 text-white py-4 rounded-lg font-bold shadow-lg">ê°€ì… ì‹ ì²­</button>
            </div>
        </div>
    </div>

    <div id="main-dashboard" class="hidden h-screen flex flex-col">
        <div class="stats-panel">
            <div class="stat-item">
                <div class="label">ì´ì›</div>
                <div class="value" id="stat-total">0</div>
            </div>
            <div class="stat-item">
                <div class="label">ì‘ì—…ì¤‘</div>
                <div class="value text-green-600" id="stat-active">0</div>
            </div>
            <div class="stat-item">
                <div class="label">ì´íƒˆ</div>
                <div class="value text-gray-500" id="stat-out">0</div>
            </div>
            <div class="stat-item danger">
                <div class="label">ìœ„í—˜/SOS</div>
                <div class="value" id="stat-danger">0</div>
            </div>
        </div>

        <div class="flex-1 relative bg-gray-200">
            <div id="map" class="h-full w-full outline-none"></div>
            
            <div class="absolute bottom-4 left-4 z-[500] flex flex-col gap-2">
                <div class="bg-white/90 px-3 py-1 rounded-lg shadow border text-xs">
                    <span id="user-display" class="font-bold"></span>
                </div>
                <button onclick="logout()" class="bg-gray-800 text-white px-3 py-1 rounded-lg text-xs shadow">ë¡œê·¸ì•„ì›ƒ</button>
            </div>

            <button onclick="triggerSOS()" class="sos-btn">
                <i class="fa-solid fa-bell"></i> SOS
            </button>
        </div>
    </div>

    <script>
        // === 1. ì‹œìŠ¤í…œ ì„¤ì • ===
        const firebaseConfig = {
            apiKey: "AIzaSyCMWQa-O2m8BB0XHzhXlYfdy3smIsgKs0A",
            authDomain: "smart-safety-monitor-37649.firebaseapp.com",
            projectId: "smart-safety-monitor-37649",
            storageBucket: "smart-safety-monitor-37649.firebasestorage.app",
            messagingSenderId: "409985776476",
            appId: "1:409985776476:web:a36b3b93e734878fb35f99",
            measurementId: "G-E73V9VHXR3"
        };

        let app, auth, db;
        const appId = "default-app-id";
        let map, currentUser = null;
        let markers = {}; 
        let zones = []; // êµ¬ì—­ ì •ë³´ ì €ì¥
        let activeWorkers = []; // ì‘ì—…ì ëª©ë¡

        // í˜ì´ì§€ ë¡œë“œ ì‹œ
        window.addEventListener('load', () => {
            try {
                app = firebase.initializeApp(firebaseConfig);
                auth = firebase.auth();
                db = firebase.firestore();
                
                // [ì¤‘ìš”] ì—ëŸ¬ ì›ì¸ì´ì—ˆë˜ ì„¤ì • ì œê±°í•˜ê³  ê¸°ë³¸ ì„¤ì • ì‚¬ìš©
                // db.settings({ ... }); <- ì œê±°í•¨

                loadSites(); 
                
                const saved = localStorage.getItem('savedUser');
                if(saved) {
                    try { currentUser = JSON.parse(saved); startSession(); } catch(e){}
                }
            } catch (e) {
                alert("ì´ˆê¸°í™” ì˜¤ë¥˜: " + e.message);
            }
            setupUI();
        });

        function setupUI() {
            document.getElementById('tab-login').onclick = () => {
                document.getElementById('form-login').classList.remove('hidden');
                document.getElementById('form-signup').classList.add('hidden');
            };
            document.getElementById('tab-signup').onclick = () => {
                document.getElementById('form-login').classList.add('hidden');
                document.getElementById('form-signup').classList.remove('hidden');
            };
            document.getElementById('btn-show-pw').onclick = () => {
                const pw = document.getElementById('login-pw');
                pw.type = pw.type === 'password' ? 'text' : 'password';
            };
        }

        // === 2. ë¡œê·¸ì¸ & íšŒì›ê°€ì… ===
        async function handleLogin() {
            const id = document.getElementById('login-id').value;
            const pw = document.getElementById('login-pw').value;
            if(!id || !pw) return alert("ì •ë³´ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
            
            try {
                if (!auth.currentUser) await auth.signInAnonymously();

                // ê´€ë¦¬ì ìë™ìƒì„± (ì²« ë¡œê·¸ì¸ìš©)
                if(id === 'dark584' && pw === 'Rufghs0423!!') {
                    const check = await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('users').where('id', '==', 'dark584').get();
                    if(check.empty) {
                        await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('users').add({
                            id: 'dark584', pw: 'Rufghs0423!!', name: 'ìµœê³  ê´€ë¦¬ì', role: 'super_admin', approved: true, siteId: 'all'
                        });
                    }
                }

                const snapshot = await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('users')
                    .where('id', '==', id).where('pw', '==', pw).get();

                if (snapshot.empty) return alert("ê³„ì • ì •ë³´ê°€ í‹€ë¦½ë‹ˆë‹¤.");
                const userData = snapshot.docs[0].data();
                userData.docId = snapshot.docs[0].id; // Doc ID ì €ì¥

                if (!userData.approved) return alert("ìŠ¹ì¸ ëŒ€ê¸° ì¤‘ì…ë‹ˆë‹¤.");

                currentUser = userData;
                if(document.getElementById('auto-login-check').checked) {
                    localStorage.setItem('savedUser', JSON.stringify(currentUser));
                }
                startSession();

            } catch (error) {
                alert("ë¡œê·¸ì¸ ì‹¤íŒ¨: " + error.message);
            }
        }

        async function handleSignup() {
            const id = document.getElementById('reg-id').value;
            const name = document.getElementById('reg-name').value;
            const pw = document.getElementById('reg-pw').value;
            const siteId = document.getElementById('reg-site').value;
            const role = document.getElementById('reg-role').value;

            if(!id || !name || !pw) return alert("ëª¨ë“  ì •ë³´ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");

            try {
                if (!auth.currentUser) await auth.signInAnonymously();
                const check = await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('users').where('id', '==', id).get();
                if(!check.empty) return alert("ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ IDì…ë‹ˆë‹¤.");

                await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('users').add({
                    id, name, pw, siteId, role, approved: false, createdAt: Date.now()
                });
                alert("ê°€ì… ì‹ ì²­ ì™„ë£Œ!");
                document.getElementById('tab-login').click();
            } catch (e) { alert("ì˜¤ë¥˜: " + e.message); }
        }

        // === 3. ë©”ì¸ ê¸°ëŠ¥ (ì§€ë„, GPS, í†µê³„) ===
        async function startSession() {
            document.getElementById('auth-screen').classList.add('hidden');
            document.getElementById('main-dashboard').classList.remove('hidden');
            document.getElementById('user-display').innerText = `${currentUser.name} (${currentUser.role})`;

            // ì§€ë„ ë¡œë“œ
            if(!map) {
                map = L.map('map', {zoomControl: false}).setView([37.5665, 126.9780], 15);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
            }

            // í•˜ì´ë¸Œë¦¬ë“œ GPS ì‹œì‘ (í™”ë©´ êº¼ì§ ë°©ì§€ + GPS)
            activateKeepAlive();
            startHybridGPS();

            // êµ¬ì—­(í˜„ì¥) ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸°
            loadZones();

            // ë™ë£Œ ìœ„ì¹˜ & í†µê³„ êµ¬ë…
            subscribeWorkers();
        }

        function activateKeepAlive() {
            const video = document.getElementById('keep-alive-video');
            video.play().catch(() => {}); // ìë™ì¬ìƒ ì‹œë„
            if ('wakeLock' in navigator) {
                navigator.wakeLock.request('screen').catch(() => {});
            }
        }

        function startHybridGPS() {
            if(navigator.geolocation) {
                navigator.geolocation.watchPosition(
                    (pos) => {
                        const { latitude, longitude } = pos.coords;
                        
                        // ë‚´ ìœ„ì¹˜ ë§ˆì»¤
                        if(markers['me']) map.removeLayer(markers['me']);
                        markers['me'] = L.circleMarker([latitude, longitude], {
                            radius: 8, color: '#1e3a8a', fillOpacity: 0.9
                        }).addTo(map);
                        
                        // ì§€ë„ ì²˜ìŒ í•œ ë²ˆë§Œ ì´ë™
                        // map.panTo([latitude, longitude]); 

                        updateMyPosition(latitude, longitude);
                    },
                    (err) => console.log("GPS Error"),
                    { enableHighAccuracy: true, maximumAge: 0, timeout: 20000 }
                );
            }
        }

        async function updateMyPosition(lat, lng) {
            if(!currentUser || !db) return;
            
            // ì´íƒˆ ì—¬ë¶€ í™•ì¸ (êµ¬ì—­ì´ ìˆì„ ê²½ìš°)
            let isOut = false;
            if (zones.length > 0) {
                // ê°„ë‹¨í•œ ê±°ë¦¬ ê¸°ë°˜ ì²´í¬ (ì„ì‹œ: êµ¬ì—­ ì¤‘ì‹¬ì—ì„œ 500m ì´ë‚´ë©´ ì •ìƒ)
                // ì‹¤ì œ í´ë¦¬ê³¤ ì²´í¬ëŠ” ë³µì¡í•˜ë¯€ë¡œ ì—¬ê¸°ì„œëŠ” ìƒëµí•˜ê±°ë‚˜ ì„œë²„ ì‚¬ì´ë“œ ê¶Œì¥
                // ì—¬ê¸°ì„œëŠ” zones ë°ì´í„°ê°€ ìˆìœ¼ë©´ ê·¸ ì¤‘ í•˜ë‚˜ë¼ë„ í¬í•¨ë˜ëŠ”ì§€ í™•ì¸í•œë‹¤ê³  ê°€ì •
                isOut = !checkInZone(lat, lng);
            }

            await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('workers').doc(currentUser.id).set({
                name: currentUser.name, role: currentUser.role, siteId: currentUser.siteId,
                lat: lat, lng: lng, lastUpdate: Date.now(), isVisible: true, isOut: isOut
            }, { merge: true });
        }

        function checkInZone(lat, lng) {
            if (zones.length === 0) return true; // êµ¬ì—­ ì—†ìœ¼ë©´ ì´íƒˆ ì•„ë‹˜
            // ì—¬ê¸°ì„œëŠ” ê°„ë‹¨íˆ ì²« ë²ˆì§¸ êµ¬ì—­ì˜ í¬ì¸íŠ¸ë“¤ê³¼ ë¹„êµí•˜ëŠ” ë¡œì§ (Point in Polygon)
            // (êµ¬í˜„ ìƒëµ: ë³µì¡ë„ ì¤„ì´ê¸° ìœ„í•´. í•„ìš”ì‹œ ì¶”ê°€ ê°€ëŠ¥)
            return true; 
        }

        function subscribeWorkers() {
            let query = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('workers');
            if(currentUser.siteId !== 'all') query = query.where('siteId', '==', currentUser.siteId);

            query.onSnapshot((snapshot) => {
                activeWorkers = [];
                let sosCount = 0;
                let outCount = 0;

                snapshot.forEach(doc => {
                    const data = doc.data();
                    activeWorkers.push(data);

                    // 5ë¶„ ì´ë‚´ ì—…ë°ì´íŠ¸ëœ ì‚¬ëŒë§Œ ì§€ë„ì— í‘œì‹œ
                    if(Date.now() - data.lastUpdate < 300000) {
                        if(data.id !== currentUser.id) {
                            if(markers[doc.id]) map.removeLayer(markers[doc.id]);
                            const color = data.isSOS ? '#ef4444' : (data.isOut ? '#6b7280' : '#3b82f6');
                            const marker = L.circleMarker([data.lat, data.lng], {
                                radius: data.isSOS ? 12 : 6, color: color, fillColor: color, fillOpacity: 0.8
                            }).addTo(map).bindPopup(`${data.name} (${data.role})`);
                            markers[doc.id] = marker;
                        }
                    }

                    if(data.isSOS) sosCount++;
                    if(data.isOut) outCount++;
                });

                // í†µê³„ ì—…ë°ì´íŠ¸
                updateStats(activeWorkers.length, activeWorkers.length - outCount, outCount, sosCount);
            });
        }

        function updateStats(total, active, out, danger) {
            document.getElementById('stat-total').innerText = total;
            document.getElementById('stat-active').innerText = active;
            document.getElementById('stat-out').innerText = out;
            document.getElementById('stat-danger').innerText = danger;
        }

        function loadZones() {
            // êµ¬ì—­ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
            db.collection('artifacts').doc(appId).collection('public').doc('data').collection('zones').onSnapshot(snap => {
                zones = [];
                snap.forEach(doc => {
                    const z = doc.data();
                    // ì§€ë„ì— êµ¬ì—­ ê·¸ë¦¬ê¸°
                    const poly = L.polygon(JSON.parse(z.points), { color: z.type === 'danger' ? 'red' : 'blue', fillOpacity: 0.1 }).addTo(map);
                    zones.push(z);
                });
            });
        }

        function loadSites() {
            try {
                if (!auth.currentUser) auth.signInAnonymously();
                db.collection('artifacts').doc(appId).collection('public').doc('data').collection('sites').onSnapshot(snap => {
                    const sel = document.getElementById('reg-site');
                    sel.innerHTML = '';
                    snap.forEach(doc => {
                        sel.innerHTML += `<option value="${doc.id}">${doc.data().name}</option>`;
                    });
                    if(sel.innerHTML === '') sel.innerHTML = '<option value="default">ê¸°ë³¸ í˜„ì¥</option>';
                });
            } catch(e) {}
        }

        window.logout = function() { localStorage.removeItem('savedUser'); location.reload(); };
        window.triggerSOS = function() {
            if(currentUser && db && confirm("ğŸš¨ ê¸´ê¸‰ êµ¬ì¡° ìš”ì²­ì„ ë³´ëƒ…ë‹ˆê¹Œ?")) {
                db.collection('artifacts').doc(appId).collection('public').doc('data').collection('workers').doc(currentUser.id).set({ isSOS: true }, { merge: true });
                alert("êµ¬ì¡° ìš”ì²­ ì „ì†¡ ì™„ë£Œ!");
            }
        };
    </script>
</body>
</html>