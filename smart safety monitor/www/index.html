<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ìŠ¤ë§ˆíŠ¸ ì•ˆì „ ê´€ì œ v9.56 (Force Mode)</title>
    
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#1e3a8a">
    <link rel="icon" id="favicon" href="">

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

    <style>
        body { font-family: 'Noto Sans KR', sans-serif; user-select: none; }
        .map-container { height: 100vh; width: 100%; z-index: 10; }
        .sos-btn { position: absolute; bottom: 100px; right: 20px; z-index: 1000; width: 60px; height: 60px; border-radius: 50%; background: #ef4444; color: white; display: flex; align-items: center; justify-content: center; font-weight: bold; box-shadow: 0 4px 15px rgba(239,68,68,0.5); border: 3px solid white; }
        .sos-btn:active { transform: scale(0.95); }
        #loading-screen { position: fixed; inset: 0; background: white; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        #force-entry-btn { margin-top: 20px; padding: 10px 20px; background: #333; color: white; border-radius: 5px; font-size: 12px; display: none; cursor: pointer; }
    </style>
</head>
<body class="bg-gray-100 overflow-hidden h-screen w-screen">

    <div id="loading-screen">
        <div class="text-4xl animate-bounce mb-4">ğŸ›¡ï¸</div>
        <p class="text-gray-500 font-bold" id="loading-msg">ì‹œìŠ¤í…œ ë¦¬ì†ŒìŠ¤ ë¡œë”© ì¤‘...</p>
        <button id="force-entry-btn" onclick="forceEnter()">âš ï¸ ì‘ë‹µì´ ì—†ìœ¼ë©´ í´ë¦­ (ê°•ì œ ì ‘ì†)</button>
    </div>

    <div id="auth-screen" class="fixed inset-0 z-50 flex items-center justify-center bg-gray-900 bg-opacity-90 hidden">
        <div class="bg-white p-8 rounded-lg shadow-2xl w-full max-w-md m-4">
            <div class="text-center mb-6">
                <h1 class="text-2xl font-bold text-gray-800">ìŠ¤ë§ˆíŠ¸ ì•ˆì „ ê´€ì œ</h1>
                <p class="text-sm text-gray-500">v9.56 Force Mode</p>
            </div>

            <div class="flex border-b mb-4">
                <button id="tab-login" class="flex-1 py-2 font-bold text-blue-600 border-b-2 border-blue-600">ë¡œê·¸ì¸</button>
                <button id="tab-signup" class="flex-1 py-2 text-gray-500">íšŒì›ê°€ì…</button>
            </div>

            <div id="form-login" class="space-y-4">
                <input type="text" id="login-id" placeholder="ì•„ì´ë””" class="w-full border p-3 rounded">
                <div class="relative">
                    <input type="password" id="login-pw" placeholder="ë¹„ë°€ë²ˆí˜¸" class="w-full border p-3 rounded">
                    <button id="btn-show-pw" class="absolute right-3 top-3 text-gray-400"><i class="fa-solid fa-eye"></i></button>
                </div>
                <div class="flex items-center gap-2">
                    <input type="checkbox" id="auto-login-check" class="w-4 h-4">
                    <label for="auto-login-check" class="text-sm">ìë™ ë¡œê·¸ì¸</label>
                </div>
                <button id="btn-login" class="w-full bg-blue-800 text-white py-3 rounded font-bold shadow-lg">ë¡œê·¸ì¸</button>
            </div>

            <div id="form-signup" class="space-y-4 hidden">
                <input type="text" id="reg-id" placeholder="ì•„ì´ë””" class="w-full border p-3 rounded">
                <input type="text" id="reg-name" placeholder="ì´ë¦„" class="w-full border p-3 rounded">
                <input type="password" id="reg-pw" placeholder="ë¹„ë°€ë²ˆí˜¸" class="w-full border p-3 rounded">
                <div class="border p-2 rounded bg-gray-50">
                    <label class="text-xs font-bold text-gray-500">í˜„ì¥ ì„ íƒ</label>
                    <select id="reg-site" class="w-full border p-2 rounded bg-white"></select>
                </div>
                <select id="reg-role" class="w-full border p-3 rounded bg-white">
                    <option value="worker">ê·¼ë¡œì</option>
                    <option value="admin">í˜„ì¥ì†Œì¥</option>
                    <option value="safety">ì•ˆì „ê´€ë¦¬ì</option>
                </select>
                <button id="btn-signup" class="w-full bg-green-600 text-white py-3 rounded font-bold">ê°€ì… ì‹ ì²­</button>
            </div>
        </div>
    </div>

    <div id="main-dashboard" class="hidden h-screen flex flex-col">
        <div class="bg-slate-800 text-white p-4 flex justify-between items-center z-50 shadow">
            <div class="font-bold">ê´€ì œ ìƒí™©ì‹¤ <span id="user-display" class="text-xs font-normal text-gray-300 ml-2"></span></div>
            <button onclick="logout()" class="text-xs bg-slate-700 px-3 py-1 rounded">ë¡œê·¸ì•„ì›ƒ</button>
        </div>
        <div class="flex-1 relative">
            <div id="map" class="h-full w-full"></div>
            <button onclick="triggerSOS()" class="sos-btn shadow-lg">SOS</button>
            <div class="absolute top-4 left-4 bg-white/90 p-3 rounded shadow z-[500] text-xs">
                <div class="font-bold mb-1">GPS ìƒíƒœ: <span id="gps-status" class="text-green-600">ì—°ê²° ëŒ€ê¸°</span></div>
                <div>ì •í™•ë„: <span id="gps-acc">-</span> m</div>
            </div>
        </div>
    </div>

    <script>
        // 0. ê°•ì œ ì ‘ì† ê¸°ëŠ¥ (ê°€ì¥ ë¨¼ì € ì‹¤í–‰)
        function forceEnter() {
            document.getElementById('loading-screen').classList.add('hidden');
            document.getElementById('auth-screen').classList.remove('hidden');
        }
        
        // 3ì´ˆ ë’¤ì—ë„ ë¡œë”© ì•ˆ ëë‚˜ë©´ 'ê°•ì œ ì ‘ì† ë²„íŠ¼' í‘œì‹œ
        setTimeout(() => {
            const loading = document.getElementById('loading-screen');
            if (!loading.classList.contains('hidden')) {
                document.getElementById('loading-msg').innerText = "ì ‘ì†ì´ ì§€ì—°ë˜ê³  ìˆìŠµë‹ˆë‹¤.";
                document.getElementById('force-entry-btn').style.display = 'block';
            }
        }, 3000);

        // 1. Firebase ì„¤ì •
        const firebaseConfig = {
            apiKey: "AIzaSyCMWQa-O2m8BB0XHzhXlYfdy3smIsgKs0A",
            authDomain: "smart-safety-monitor-37649.firebaseapp.com",
            projectId: "smart-safety-monitor-37649",
            storageBucket: "smart-safety-monitor-37649.firebasestorage.app",
            messagingSenderId: "409985776476",
            appId: "1:409985776476:web:a36b3b93e734878fb35f99",
            measurementId: "G-E73V9VHXR3"
        };

        let app, auth, db;
        try {
            if (typeof firebase !== 'undefined') {
                app = firebase.initializeApp(firebaseConfig);
                auth = firebase.auth();
                db = firebase.firestore();
            } else {
                console.error("Firebase SDK ë¡œë“œ ì‹¤íŒ¨");
            }
        } catch (e) {
            console.error("Firebase ì´ˆê¸°í™” ì—ëŸ¬: ", e);
        }

        const appId = "default-app-id";
        let map, currentUser = null;
        let markers = {}; 

        // 2. í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ ì‹œ
        document.addEventListener('DOMContentLoaded', () => {
            // ì •ìƒ ë¡œë”© ì‹œ 1ì´ˆ ë’¤ ìë™ ì§„ì…
            setTimeout(() => {
                forceEnter();
                if(db) loadSites();
            }, 1000);

            // íƒ­ ë° ë²„íŠ¼ ì´ë²¤íŠ¸ ì—°ê²°
            document.getElementById('tab-login').onclick = () => {
                document.getElementById('form-login').classList.remove('hidden');
                document.getElementById('form-signup').classList.add('hidden');
                document.getElementById('tab-login').className = "flex-1 py-2 font-bold text-blue-600 border-b-2 border-blue-600";
                document.getElementById('tab-signup').className = "flex-1 py-2 text-gray-500";
            };
            document.getElementById('tab-signup').onclick = () => {
                document.getElementById('form-login').classList.add('hidden');
                document.getElementById('form-signup').classList.remove('hidden');
                document.getElementById('tab-signup').className = "flex-1 py-2 font-bold text-blue-600 border-b-2 border-blue-600";
                document.getElementById('tab-login').className = "flex-1 py-2 text-gray-500";
            };

            document.getElementById('btn-show-pw').onclick = () => {
                const pw = document.getElementById('login-pw');
                pw.type = pw.type === 'password' ? 'text' : 'password';
            };

            document.getElementById('btn-login').onclick = handleLogin;
            document.getElementById('btn-signup').onclick = handleSignup;
            
            const saved = localStorage.getItem('savedUser');
            if(saved) {
                try { currentUser = JSON.parse(saved); startSession(); } catch(e){}
            }
        });

        // 3. ë¡œê·¸ì¸ í•¨ìˆ˜
        async function handleLogin() {
            if (!auth) return alert("ì„œë²„ ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì¸í„°ë„· ìƒíƒœë¥¼ í™•ì¸í•˜ê±°ë‚˜ í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ì„¸ìš”.");
            const id = document.getElementById('login-id').value;
            const pw = document.getElementById('login-pw').value;
            
            if(!id || !pw) return alert("ì•„ì´ë””ì™€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
            
            try {
                if (!auth.currentUser) await auth.signInAnonymously();

                // ìµœê³  ê´€ë¦¬ì ìƒì„±
                if(id === 'dark584' && pw === 'Rufghs0423!!') {
                    const check = await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('users').where('id', '==', 'dark584').get();
                    if(check.empty) {
                        await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('users').add({
                            id: 'dark584', pw: 'Rufghs0423!!', name: 'ìµœê³  ê´€ë¦¬ì', role: 'super_admin', approved: true, siteId: 'all'
                        });
                    }
                }

                const snapshot = await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('users')
                    .where('id', '==', id).where('pw', '==', pw).get();

                if (snapshot.empty) return alert("ì•„ì´ë”” ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.");

                const userDoc = snapshot.docs[0];
                const userData = userDoc.data();
                userData.docId = userDoc.id;

                if (!userData.approved) return alert("ìŠ¹ì¸ ëŒ€ê¸° ì¤‘ì…ë‹ˆë‹¤.");

                currentUser = userData;
                if(document.getElementById('auto-login-check').checked) {
                    localStorage.setItem('savedUser', JSON.stringify(currentUser));
                }

                alert("ë¡œê·¸ì¸ ì„±ê³µ!");
                startSession();

            } catch (error) {
                alert("ë¡œê·¸ì¸ ì—ëŸ¬: " + error.message);
            }
        }

        // 4. íšŒì›ê°€ì… í•¨ìˆ˜
        async function handleSignup() {
            if (!auth) return alert("ì„œë²„ ì—°ê²° ì‹¤íŒ¨");
            const id = document.getElementById('reg-id').value;
            const name = document.getElementById('reg-name').value;
            const pw = document.getElementById('reg-pw').value;
            const siteId = document.getElementById('reg-site').value;
            const role = document.getElementById('reg-role').value;

            if(!id || !name || !pw || !siteId) return alert("ëª¨ë“  ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");

            try {
                if (!auth.currentUser) await auth.signInAnonymously();
                
                const check = await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('users').where('id', '==', id).get();
                if(!check.empty) return alert("ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ì•„ì´ë””ì…ë‹ˆë‹¤.");

                await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('users').add({
                    id, name, pw, siteId, role, approved: false, createdAt: Date.now()
                });

                alert("ê°€ì… ì‹ ì²­ ì™„ë£Œ! ê´€ë¦¬ì ìŠ¹ì¸ì„ ê¸°ë‹¤ë¦¬ì„¸ìš”.");
                document.getElementById('tab-login').click();

            } catch (error) {
                alert("ê°€ì… ì—ëŸ¬: " + error.message);
            }
        }

        function startSession() {
            document.getElementById('auth-screen').classList.add('hidden');
            document.getElementById('main-dashboard').classList.remove('hidden');
            document.getElementById('user-display').innerText = `${currentUser.name}`;

            if(!map) {
                map = L.map('map').setView([38.205, 127.115], 15);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
            }

            if(navigator.geolocation) {
                navigator.geolocation.watchPosition(
                    (pos) => {
                        const { latitude, longitude, accuracy } = pos.coords;
                        document.getElementById('gps-status').innerText = "ì •ìƒğŸŸ¢";
                        document.getElementById('gps-acc').innerText = Math.round(accuracy);
                        updateMyPosition(latitude, longitude);
                    },
                    (err) => { document.getElementById('gps-status').innerText = "ì‹ í˜¸ ì•½í•¨ğŸ”´"; },
                    { enableHighAccuracy: true }
                );
            }
            subscribeWorkers();
        }

        async function updateMyPosition(lat, lng) {
            if(!currentUser || !db) return;
            await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('workers').doc(currentUser.id).set({
                name: currentUser.name,
                role: currentUser.role,
                siteId: currentUser.siteId,
                lat: lat,
                lng: lng,
                lastUpdate: Date.now(),
                isVisible: true
            }, { merge: true });
        }

        function subscribeWorkers() {
            if (!db) return;
            let query = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('workers');
            if(currentUser.siteId !== 'all') {
                query = query.where('siteId', '==', currentUser.siteId);
            }

            query.onSnapshot((snapshot) => {
                snapshot.forEach(doc => {
                    const data = doc.data();
                    if(data.id === currentUser.id) return;
                    if(markers[doc.id]) map.removeLayer(markers[doc.id]);
                    const marker = L.circleMarker([data.lat, data.lng], {
                        radius: 6, color: data.isSOS ? 'red' : 'blue'
                    }).addTo(map).bindPopup(data.name);
                    markers[doc.id] = marker;
                });
            });
        }

        function loadSites() {
            try {
                if (!auth.currentUser) auth.signInAnonymously();
                db.collection('artifacts').doc(appId).collection('public').doc('data').collection('sites').onSnapshot(snap => {
                    const sel = document.getElementById('reg-site');
                    sel.innerHTML = '<option value="" disabled selected>í˜„ì¥ ì„ íƒ</option>';
                    snap.forEach(doc => {
                        sel.innerHTML += `<option value="${doc.id}">${doc.data().name}</option>`;
                    });
                });
            } catch(e) {}
        }

        window.logout = function() {
            localStorage.removeItem('savedUser');
            location.reload();
        };

        window.triggerSOS = function() {
            if(currentUser && db) {
                db.collection('artifacts').doc(appId).collection('public').doc('data').collection('workers').doc(currentUser.id).set({
                    isSOS: true
                }, { merge: true });
                alert("êµ¬ì¡° ìš”ì²­ì„ ë³´ëƒˆìŠµë‹ˆë‹¤!");
            }
        };
    </script>
</body>
</html>