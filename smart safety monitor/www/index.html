<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ìŠ¤ë§ˆíŠ¸ ì•ˆì „ ê´€ì œ (Pro v9.90)</title>
    
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#b91c1c"> <link rel="icon" id="favicon" href="">

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

    <style>
        body { font-family: 'Noto Sans KR', sans-serif; user-select: none; overflow: hidden; }
        .map-container { height: 100vh; width: 100%; z-index: 10; }
        
        /* SOS ë²„íŠ¼ */
        .sos-btn { 
            position: absolute; bottom: 100px; right: 20px; z-index: 1000; 
            width: 70px; height: 70px; border-radius: 50%; 
            background: linear-gradient(135deg, #ef4444, #991b1b); 
            color: white; display: flex; flex-direction: column; 
            align-items: center; justify-content: center; 
            font-weight: bold; font-size: 14px;
            box-shadow: 0 4px 20px rgba(220, 38, 38, 0.7); 
            border: 3px solid white; animation: pulse-sos 2s infinite;
        }
        @keyframes pulse-sos { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }

        /* ìœ„í—˜ ê²½ë³´ ì‹œ í™”ë©´ ì ë©¸ íš¨ê³¼ */
        @keyframes flash-screen { 
            0%, 100% { box-shadow: inset 0 0 0 0 rgba(255,0,0,0); } 
            50% { box-shadow: inset 0 0 100px 50px rgba(255,0,0,0.8); background-color: rgba(255,0,0,0.2); } 
        }
        .danger-mode { animation: flash-screen 0.5s infinite; border: 5px solid red; }

        /* ê´€ë¦¬ì ë„êµ¬ íŒ¨ë„ */
        #admin-toolbar {
            position: absolute; top: 70px; left: 10px; z-index: 1000;
            background: white; padding: 10px; border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2); display: none; width: 200px;
        }

        /* ì•Œë¦¼í•¨ */
        #notification-box {
            position: absolute; top: 60px; right: 10px; z-index: 1100;
            background: white; width: 300px; max-height: 400px;
            border-radius: 10px; box-shadow: 0 10px 25px rgba(0,0,0,0.3);
            display: none; flex-direction: column; overflow: hidden;
        }
        .noti-item { padding: 10px; border-bottom: 1px solid #eee; font-size: 12px; }
        .noti-item.danger { background: #fee2e2; border-left: 4px solid #ef4444; }
        .noti-item.info { background: #f0f9ff; border-left: 4px solid #3b82f6; }

        /* ë°±ê·¸ë¼ìš´ë“œ ìœ ì§€ìš© */
        #keep-alive-video { position: absolute; top: 0; left: 0; width: 1px; height: 1px; opacity: 0.01; pointer-events: none; }
    </style>
</head>
<body class="bg-gray-100 h-screen w-screen">

    <video id="keep-alive-video" playsinline muted loop>
        <source src="data:video/mp4;base64,AAAAHGZ0eXBpc29tAAACAGlzb21pc28yYXZjMQAAAAhmcmVlAAACQm1kYXQAAAGzABAHAAABthADAQAAAB5lbHN0AAAAAAAAAAEAAAABAAAAAAABAAAAAAABAAAAAAOBbW9vdgAAAGxtdmhkAAAAAAAAGNQAABjUAAABAAABAAAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAgAAAAh0cmFrAAAAXHRraGQAAAADAAAAGNQAABjUAAAAAQAAAAABAAAAAAAAAAAAAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABAAAAAAIAAAAkZWR0cwAAABxlbHN0AAAAAAAAAAEAAAABAAAAAAABAAAAAAABAAAAAAOibWRpYQAAACBtZGhkAAAAABjUAAAY1AAAAQAAAQAAAAABAFgAAAAAAAhWhGRscgAAAAAAAAAAbWluZgAAABR2bWhkAAAAAQAAAAAAAAAAAAAAJGRpbmYAAAAcZHJlZgAAAAAAAAABAAAADHVybCAAAAABAAADWnN0YmwAAAB5c3RzZAAAAAAAAAABAAAAiWF2YzEAAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAEAAQABAAAAAAABAAAAAAAAAAAAAAABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAGP//AAAALWF2Y0MBWQAa//8AAAAuZ2RrdRWbCAoBwQAAA+gA8F2D3awEBAQAAAAEAAAAAAQAAAAEAAAACHN0dHMAAAAAAAAAAQAAAAEAAAB4Y3R0cwAAAAAAAAAAAAABAAEAAAAcY3R0cwAAAAAAAAAAAAABAAEAAAAcc3RzYwAAAAAAAAABAAAAAQAAAAEAAAABAAAAFHN6LmEAAAAAAAAAAQAAAAQAAAA0c3RjbwAAAAAAAAABAAAAAAA=" type="video/mp4">
    </video>

    <audio id="siren-sound" loop src="https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg"></audio>

    <div id="auth-screen" class="fixed inset-0 z-50 flex items-center justify-center bg-gray-900 bg-opacity-90">
        <div class="bg-white p-8 rounded-lg shadow-2xl w-full max-w-md m-4 relative">
            <h1 class="text-2xl font-bold text-center mb-6">ìŠ¤ë§ˆíŠ¸ ì•ˆì „ ê´€ì œ v9.90</h1>
            <div id="form-login" class="space-y-4">
                <input type="text" id="login-id" placeholder="ì•„ì´ë””" class="w-full border p-3 rounded">
                <input type="password" id="login-pw" placeholder="ë¹„ë°€ë²ˆí˜¸" class="w-full border p-3 rounded">
                <button onclick="handleLogin()" class="w-full bg-blue-900 text-white py-4 rounded font-bold">ì ‘ì†í•˜ê¸°</button>
                <div class="text-center mt-2">
                    <button onclick="toggleSignup()" class="text-sm text-gray-500 underline">íšŒì›ê°€ì…</button>
                </div>
            </div>
            <div id="form-signup" class="space-y-4 hidden">
                <input type="text" id="reg-id" placeholder="ì•„ì´ë””" class="w-full border p-3 rounded">
                <input type="text" id="reg-name" placeholder="ì´ë¦„" class="w-full border p-3 rounded">
                <input type="password" id="reg-pw" placeholder="ë¹„ë°€ë²ˆí˜¸" class="w-full border p-3 rounded">
                <select id="reg-role" class="w-full border p-3 rounded">
                    <option value="worker">ê·¼ë¡œì</option>
                    <option value="admin">ê´€ë¦¬ì (ê·¸ë¦¬ê¸° ê°€ëŠ¥)</option>
                </select>
                <button onclick="handleSignup()" class="w-full bg-green-600 text-white py-4 rounded font-bold">ê°€ì… ì‹ ì²­</button>
                <button onclick="toggleSignup()" class="w-full bg-gray-200 py-2 rounded mt-2">ì·¨ì†Œ</button>
            </div>
        </div>
    </div>

    <div id="main-dashboard" class="hidden h-screen flex flex-col relative">
        <div class="bg-white px-4 py-2 flex justify-between items-center shadow z-20">
            <div class="text-sm font-bold" id="user-info">ì ‘ì† ì¤‘...</div>
            <div class="flex gap-2">
                <button onclick="toggleNotiBox()" class="relative p-2 bg-gray-100 rounded-full">
                    <i class="fa-solid fa-bell text-gray-600"></i>
                    <span id="noti-badge" class="absolute top-0 right-0 w-3 h-3 bg-red-500 rounded-full hidden"></span>
                </button>
                <button onclick="logout()" class="p-2 bg-gray-800 text-white rounded text-xs">ë¡œê·¸ì•„ì›ƒ</button>
            </div>
        </div>

        <div class="flex bg-white border-b text-center text-xs py-2 z-10 shadow-sm">
            <div class="flex-1 border-r">ì´ì›<br><span id="st-total" class="font-bold text-lg">0</span></div>
            <div class="flex-1 border-r text-green-600">ì‘ì—…ì¤‘<br><span id="st-in" class="font-bold text-lg">0</span></div>
            <div class="flex-1 border-r text-gray-500">ì´íƒˆ<br><span id="st-out" class="font-bold text-lg">0</span></div>
            <div class="flex-1 text-red-600 animate-pulse">ìœ„í—˜<br><span id="st-danger" class="font-bold text-lg">0</span></div>
        </div>

        <div class="flex-1 relative bg-gray-200">
            <div id="map" class="h-full w-full"></div>
            
            <div id="admin-toolbar">
                <h3 class="font-bold text-sm mb-2 border-b pb-1">êµ¬ì—­ ì„¤ì • ë„êµ¬</h3>
                <select id="draw-type" class="w-full border p-1 mb-2 text-xs">
                    <option value="danger">ğŸš« ìœ„í—˜êµ¬ì—­ (ì²´ë¥˜ì œí•œ)</option>
                    <option value="safe">âœ… ì•ˆì „/ì‘ì—…êµ¬ì—­</option>
                    <option value="rest">â˜• íœ´ê²Œì‹¤</option>
                    <option value="smoking">ğŸš¬ í¡ì—°ì‹¤</option>
                    <option value="aed">ğŸ’“ AED ìœ„ì¹˜</option>
                </select>
                <div id="time-limit-div" class="mb-2">
                    <label class="text-xs">ì²´ë¥˜ ì œí•œ(ì´ˆ):</label>
                    <input type="number" id="draw-time" value="60" class="w-full border p-1 text-xs">
                </div>
                <button onclick="startDrawing()" class="w-full bg-blue-600 text-white py-1 rounded text-xs mb-1">ê·¸ë¦¬ê¸° ì‹œì‘</button>
                <button onclick="cancelDrawing()" class="w-full bg-gray-200 text-gray-600 py-1 rounded text-xs">ì·¨ì†Œ</button>
                <p class="text-[10px] text-gray-400 mt-1">* ì§€ë„ í´ë¦­í•˜ì—¬ ì  ì¶”ê°€, ë”ë¸”í´ë¦­ ì™„ë£Œ</p>
            </div>

            <button onclick="triggerSOS()" class="sos-btn"><i class="fa-solid fa-bell"></i> SOS</button>
        </div>

        <div id="notification-box">
            <div class="bg-gray-100 p-3 font-bold flex justify-between">
                <span>ì•Œë¦¼ ë‚´ì—­</span>
                <button onclick="toggleNotiBox()"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div id="noti-list" class="overflow-y-auto flex-1 p-2"></div>
        </div>
    </div>

    <script>
        // === ì„¤ì • ===
        const firebaseConfig = {
            apiKey: "AIzaSyCMWQa-O2m8BB0XHzhXlYfdy3smIsgKs0A",
            authDomain: "smart-safety-monitor-37649.firebaseapp.com",
            projectId: "smart-safety-monitor-37649",
            storageBucket: "smart-safety-monitor-37649.firebasestorage.app",
            messagingSenderId: "409985776476",
            appId: "1:409985776476:web:a36b3b93e734878fb35f99",
            measurementId: "G-E73V9VHXR3"
        };

        let app, auth, db;
        const appId = "default-app-id";
        let map, currentUser = null;
        let zones = [], markers = {};
        
        // ìƒíƒœ ë³€ìˆ˜
        let isDrawing = false;
        let drawPoints = [];
        let drawPolyline = null;
        let currentZone = null; // í˜„ì¬ ë‚´ê°€ ìˆëŠ” êµ¬ì—­
        let zoneEntryTime = 0; // êµ¬ì—­ ì§„ì… ì‹œê°„
        let dangerTimer = null; // ìœ„í—˜êµ¬ì—­ íƒ€ì´ë¨¸

        // === ì´ˆê¸°í™” ===
        window.onload = () => {
            app = firebase.initializeApp(firebaseConfig);
            auth = firebase.auth();
            db = firebase.firestore();
            db.settings({ experimentalForceLongPolling: true, merge: true });

            // ìë™ ë¡œê·¸ì¸
            const saved = localStorage.getItem('savedUser');
            if(saved) {
                currentUser = JSON.parse(saved);
                startSession();
            }
            
            // ì•Œë¦¼ ê¶Œí•œ ìš”ì²­
            if(Notification.permission !== 'granted') Notification.requestPermission();
        };

        // === ë¡œê·¸ì¸/íšŒì›ê°€ì… ===
        function toggleSignup() {
            const login = document.getElementById('form-login');
            const signup = document.getElementById('form-signup');
            if(login.classList.contains('hidden')) {
                login.classList.remove('hidden'); signup.classList.add('hidden');
            } else {
                login.classList.add('hidden'); signup.classList.remove('hidden');
            }
        }

        async function handleLogin() {
            const id = document.getElementById('login-id').value;
            const pw = document.getElementById('login-pw').value;
            if(!id || !pw) return alert("ì •ë³´ ì…ë ¥ í•„ìš”");

            try {
                if(!auth.currentUser) await auth.signInAnonymously();
                
                // ê´€ë¦¬ì ìë™ìƒì„± (ìµœì´ˆ)
                if(id === 'dark584') {
                    const chk = await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('users').where('id','==',id).get();
                    if(chk.empty) {
                        await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('users').add({
                            id, pw, name: "ìµœê³ ê´€ë¦¬ì", role: "admin", approved: true
                        });
                    }
                }

                const snap = await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('users')
                    .where('id','==',id).where('pw','==',pw).get();
                
                if(snap.empty) return alert("ì •ë³´ ë¶ˆì¼ì¹˜");
                const user = snap.docs[0].data();
                user.docId = snap.docs[0].id;
                
                if(!user.approved) return alert("ìŠ¹ì¸ ëŒ€ê¸° ì¤‘");
                
                currentUser = user;
                localStorage.setItem('savedUser', JSON.stringify(user));
                startSession();
            } catch(e) { alert(e.message); }
        }

        async function handleSignup() {
            const id = document.getElementById('reg-id').value;
            const name = document.getElementById('reg-name').value;
            const pw = document.getElementById('reg-pw').value;
            const role = document.getElementById('reg-role').value;
            
            try {
                if(!auth.currentUser) await auth.signInAnonymously();
                await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('users').add({
                    id, name, pw, role, approved: false, createdAt: Date.now()
                });
                alert("ì‹ ì²­ ì™„ë£Œ"); toggleSignup();
            } catch(e) { alert(e.message); }
        }

        // === ë©”ì¸ ì„¸ì…˜ ===
        function startSession() {
            document.getElementById('auth-screen').classList.add('hidden');
            document.getElementById('main-dashboard').classList.remove('hidden');
            document.getElementById('user-info').innerText = `${currentUser.name} (${currentUser.role})`;

            if(currentUser.role === 'admin') {
                document.getElementById('admin-toolbar').style.display = 'block';
            }

            initMap();
            loadZones(); // êµ¬ì—­ ë¶ˆëŸ¬ì˜¤ê¸°
            startGPS(); // GPS ë° êµ¬ì—­ ê°ì§€ ì‹œì‘
            subscribeWorkers(); // ë‹¤ë¥¸ ì‘ì—…ì í‘œì‹œ
            document.getElementById('keep-alive-video').play().catch(()=>{});
        }

        function initMap() {
            map = L.map('map').setView([37.5665, 126.9780], 16);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
            
            // ì§€ë„ í´ë¦­ ì´ë²¤íŠ¸ (ê·¸ë¦¬ê¸°ìš©)
            map.on('click', (e) => {
                if(!isDrawing) return;
                drawPoints.push([e.latlng.lat, e.latlng.lng]);
                
                if(drawPolyline) map.removeLayer(drawPolyline);
                drawPolyline = L.polyline(drawPoints, {color: 'red'}).addTo(map);
                L.circleMarker(e.latlng, {radius:3, color:'red'}).addTo(map);
            });

            map.on('dblclick', finishDrawing);
        }

        // === êµ¬ì—­ ê·¸ë¦¬ê¸° (ê´€ë¦¬ì) ===
        function startDrawing() {
            isDrawing = true; drawPoints = [];
            map.doubleClickZoom.disable();
            alert("ì§€ë„ì— ì ì„ ì°ì–´ êµ¬ì—­ì„ ë§Œë“œì„¸ìš”. ë”ë¸”í´ë¦­í•˜ë©´ ì™„ë£Œë©ë‹ˆë‹¤.");
        }
        function cancelDrawing() {
            isDrawing = false; drawPoints = [];
            if(drawPolyline) map.removeLayer(drawPolyline);
            map.doubleClickZoom.enable();
        }
        async function finishDrawing() {
            if(drawPoints.length < 3) return alert("3ê°œ ì´ìƒ ì ì„ ì°ì–´ì•¼ í•©ë‹ˆë‹¤.");
            const type = document.getElementById('draw-type').value;
            const timeLimit = parseInt(document.getElementById('draw-time').value) || 0;
            const name = prompt("êµ¬ì—­ ì´ë¦„ ì…ë ¥:");
            if(!name) return cancelDrawing();

            await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('zones').add({
                name, type, timeLimit, points: JSON.stringify(drawPoints)
            });
            alert("êµ¬ì—­ ì €ì¥ ì™„ë£Œ");
            cancelDrawing();
        }

        // === êµ¬ì—­ ë¡œë“œ ë° í‘œì‹œ ===
        function loadZones() {
            db.collection('artifacts').doc(appId).collection('public').doc('data').collection('zones').onSnapshot(snap => {
                zones = [];
                // ê¸°ì¡´ ë ˆì´ì–´ ì •ë¦¬ í•„ìš”í•˜ì§€ë§Œ ìƒëµ (ê°„ì†Œí™”)
                snap.forEach(doc => {
                    const z = doc.data();
                    z.points = JSON.parse(z.points);
                    zones.push(z);
                    
                    let color = 'blue';
                    if(z.type === 'danger') color = 'red';
                    if(z.type === 'rest') color = 'green';
                    
                    L.polygon(z.points, {color, fillOpacity:0.2}).addTo(map)
                        .bindTooltip(`${z.name} (${z.type})`);
                });
            });
        }

        // === GPS ë° êµ¬ì—­ ê°ì§€ ë¡œì§ (í•µì‹¬) ===
        function startGPS() {
            navigator.geolocation.watchPosition(pos => {
                const { latitude, longitude } = pos.coords;
                if(markers['me']) map.removeLayer(markers['me']);
                markers['me'] = L.circleMarker([latitude, longitude], {radius:8, color:'#1e3a8a', fillOpacity:1}).addTo(map);
                
                checkZoneStatus(latitude, longitude); // êµ¬ì—­ ì²´í¬
                
                // ì„œë²„ ì—…ë°ì´íŠ¸
                db.collection('artifacts').doc(appId).collection('public').doc('data').collection('workers').doc(currentUser.docId).set({
                    name: currentUser.name, role: currentUser.role, lat: latitude, lng: longitude,
                    lastUpdate: Date.now(), isSOS: currentUser.isSOS || false
                }, {merge: true});

            }, null, {enableHighAccuracy: true});
        }

        // êµ¬ì—­ ì§„ì…/ì´íƒˆ/ì‹œê°„ì²´í¬ ì•Œê³ ë¦¬ì¦˜
        function checkZoneStatus(lat, lng) {
            let insideZone = null;

            // ë‚´ê°€ ì–´ë–¤ êµ¬ì—­ ì•ˆì— ìˆëŠ”ì§€ í™•ì¸
            for(let z of zones) {
                if(isPointInPoly([lat, lng], z.points)) {
                    insideZone = z;
                    break;
                }
            }

            // [ìƒí™© 1] ìƒˆë¡œìš´ êµ¬ì—­ ì§„ì…
            if(insideZone && (!currentZone || currentZone.name !== insideZone.name)) {
                currentZone = insideZone;
                zoneEntryTime = Date.now();
                
                let msg = `[ì§„ì…] ${insideZone.name}`;
                if(insideZone.type === 'danger') {
                    msg += " (ìœ„í—˜êµ¬ì—­! ì‹œê°„ì œí•œ " + insideZone.timeLimit + "ì´ˆ)";
                    addNotification(msg, 'danger');
                    speak(msg); // ìŒì„± ì•ˆë‚´
                } else {
                    addNotification(msg, 'info');
                }
            }

            // [ìƒí™© 2] êµ¬ì—­ ì´íƒˆ
            if(!insideZone && currentZone) {
                addNotification(`[ì´íƒˆ] ${currentZone.name}`, 'info');
                currentZone = null;
                stopAlarm(); // ì•ŒëŒ ë„ê¸°
            }

            // [ìƒí™© 3] ìœ„í—˜ êµ¬ì—­ ë‚´ ì‹œê°„ ì´ˆê³¼ ì²´í¬
            if(currentZone && currentZone.type === 'danger') {
                const elapsed = (Date.now() - zoneEntryTime) / 1000;
                if(elapsed > currentZone.timeLimit) {
                    triggerAlarm(currentZone.name);
                }
            }
        }

        // ì•ŒëŒ ë°œë™ (ì‚¬ì´ë Œ + í™”ë©´ì ë©¸)
        function triggerAlarm(zoneName) {
            document.body.classList.add('danger-mode'); // í™”ë©´ ë¹¨ê°„ ì ë©¸
            const siren = document.getElementById('siren-sound');
            if(siren.paused) {
                siren.play().catch(()=>{});
                addNotification(`ğŸš¨ ì‹œê°„ ì´ˆê³¼! ${zoneName}ì—ì„œ ì¦‰ì‹œ ëŒ€í”¼í•˜ì„¸ìš”!`, 'danger');
                // í‘¸ì‹œ ì•Œë¦¼ (ì§€ì› ë¸Œë¼ìš°ì €)
                new Notification("ìœ„í—˜ ê²½ë³´!", { body: `${zoneName} ì²´ë¥˜ ì‹œê°„ ì´ˆê³¼! ëŒ€í”¼í•˜ë¼!` });
            }
        }

        function stopAlarm() {
            document.body.classList.remove('danger-mode');
            document.getElementById('siren-sound').pause();
            document.getElementById('siren-sound').currentTime = 0;
        }

        // í¬ì¸íŠ¸ê°€ í´ë¦¬ê³¤ ì•ˆì— ìˆëŠ”ì§€ ê³„ì‚° (Ray-casting)
        function isPointInPoly(pt, vs) {
            var x = pt[0], y = pt[1];
            var inside = false;
            for (var i = 0, j = vs.length - 1; i < vs.length; j = i++) {
                var xi = vs[i][0], yi = vs[i][1];
                var xj = vs[j][0], yj = vs[j][1];
                var intersect = ((yi > y) != (yj > y)) && (x < (xj - xi) * (y - yi) / (yj - yi) + xi);
                if (intersect) inside = !inside;
            }
            return inside;
        }

        // === UI ê¸°ëŠ¥ ===
        function addNotification(msg, type) {
            const list = document.getElementById('noti-list');
            const item = document.createElement('div');
            item.className = `noti-item ${type}`;
            item.innerText = `[${new Date().toLocaleTimeString()}] ${msg}`;
            list.prepend(item);
            
            // ë°°ì§€ ì—…ë°ì´íŠ¸
            const badge = document.getElementById('noti-badge');
            badge.classList.remove('hidden');
        }

        function toggleNotiBox() {
            const box = document.getElementById('notification-box');
            box.style.display = box.style.display === 'flex' ? 'none' : 'flex';
            document.getElementById('noti-badge').classList.add('hidden');
        }

        function subscribeWorkers() {
            db.collection('artifacts').doc(appId).collection('public').doc('data').collection('workers').onSnapshot(snap => {
                let total=0, danger=0;
                snap.forEach(doc => {
                    const d = doc.data();
                    if(Date.now() - d.lastUpdate > 600000) return; // 10ë¶„ ì§€ë‚¨ ì œì™¸
                    total++;
                    if(d.isSOS) danger++;
                    
                    if(d.id !== currentUser.id) { // íƒ€ì¸ë§Œ í‘œì‹œ
                        if(markers[doc.id]) map.removeLayer(markers[doc.id]);
                        const color = d.isSOS ? 'red' : 'blue';
                        const m = L.circleMarker([d.lat, d.lng], {radius:6, color}).addTo(map).bindPopup(d.name);
                        markers[doc.id] = m;
                    }
                });
                // í†µê³„ ì—…ë°ì´íŠ¸
                document.getElementById('st-total').innerText = total;
                document.getElementById('st-danger').innerText = danger;
            });
        }

        function speak(text) {
            if('speechSynthesis' in window) {
                const utt = new SpeechSynthesisUtterance(text);
                window.speechSynthesis.speak(utt);
            }
        }

        function logout() { localStorage.removeItem('savedUser'); location.reload(); }
        
        window.triggerSOS = function() {
            if(currentUser) {
                currentUser.isSOS = true;
                db.collection('artifacts').doc(appId).collection('public').doc('data').collection('workers').doc(currentUser.docId).update({isSOS: true});
                alert("êµ¬ì¡° ìš”ì²­ ì „ì†¡ë¨!");
                triggerAlarm("SOS ê¸´ê¸‰");
            }
        }
    </script>
</body>
</html>