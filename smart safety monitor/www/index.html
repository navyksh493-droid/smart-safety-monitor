<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ìŠ¤ë§ˆíŠ¸ ì•ˆì „ ê´€ì œ v9.60 (Diagnosis)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

    <style>
        body { font-family: 'Noto Sans KR', sans-serif; background: #f3f4f6; padding: 20px; }
        #console-log { 
            width: 100%; height: 200px; 
            background: black; color: #00ff00; 
            font-family: monospace; font-size: 12px; 
            padding: 10px; overflow-y: scroll; 
            border-radius: 8px; margin-top: 20px;
            white-space: pre-wrap;
        }
    </style>
</head>
<body class="flex flex-col items-center">

    <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-md text-center">
        <h1 class="text-2xl font-bold mb-2">ì‹œìŠ¤í…œ ì§„ë‹¨ ëª¨ë“œ</h1>
        <p class="text-xs text-gray-500 mb-6">ë¡œê·¸ì¸ì´ ì•ˆ ë˜ëŠ” ì •í™•í•œ ì›ì¸ì„ ì°¾ìŠµë‹ˆë‹¤.</p>

        <div class="space-y-4 text-left">
            <div>
                <label class="text-xs font-bold text-gray-500">í…ŒìŠ¤íŠ¸ ì•„ì´ë””</label>
                <input type="text" id="login-id" value="dark584" class="w-full border p-2 rounded">
            </div>
            <div>
                <label class="text-xs font-bold text-gray-500">ë¹„ë°€ë²ˆí˜¸</label>
                <input type="text" id="login-pw" value="Rufghs0423!!" class="w-full border p-2 rounded">
            </div>
            
            <button id="btn-diagnose" class="w-full bg-blue-600 text-white py-3 rounded font-bold hover:bg-blue-700">
                ğŸš€ ì§„ë‹¨ ì‹œì‘ (í´ë¦­)
            </button>
        </div>
    </div>

    <div id="console-log">ëŒ€ê¸° ì¤‘... ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</div>

    <script>
        // í™”ë©´ì— ë¡œê·¸ ì°ëŠ” í•¨ìˆ˜
        function log(msg) {
            const box = document.getElementById('console-log');
            const time = new Date().toLocaleTimeString();
            box.innerHTML += `\n[${time}] ${msg}`;
            box.scrollTop = box.scrollHeight;
        }

        const firebaseConfig = {
            apiKey: "AIzaSyCMWQa-O2m8BB0XHzhXlYfdy3smIsgKs0A",
            authDomain: "smart-safety-monitor-37649.firebaseapp.com",
            projectId: "smart-safety-monitor-37649",
            storageBucket: "smart-safety-monitor-37649.firebasestorage.app",
            messagingSenderId: "409985776476",
            appId: "1:409985776476:web:a36b3b93e734878fb35f99",
            measurementId: "G-E73V9VHXR3"
        };

        let app, auth, db;
        const appId = "default-app-id";

        document.getElementById('btn-diagnose').onclick = async () => {
            document.getElementById('console-log').innerHTML = "=== ì§„ë‹¨ ì‹œì‘ ===";
            
            try {
                // 1. ì´ˆê¸°í™” í™•ì¸
                log("1. Firebase ì´ˆê¸°í™” ì¤‘...");
                if (typeof firebase === 'undefined') throw new Error("Firebase SDK ë¡œë“œ ì‹¤íŒ¨");
                app = firebase.initializeApp(firebaseConfig);
                auth = firebase.auth();
                db = firebase.firestore();
                log("âœ… ì´ˆê¸°í™” ì„±ê³µ!");

                // 2. ìµëª… ë¡œê·¸ì¸ í™•ì¸
                log("2. ì„œë²„ ì ‘ì†(ìµëª… ì¸ì¦) ì‹œë„...");
                await auth.signInAnonymously();
                const user = auth.currentUser;
                if(user) {
                    log(`âœ… ì ‘ì† ì„±ê³µ! (UID: ${user.uid.substring(0,5)}...)`);
                } else {
                    throw new Error("ì ‘ì† ì‹¤íŒ¨ (User null)");
                }

                // 3. DB ì½ê¸°/ì“°ê¸° ê¶Œí•œ í™•ì¸ (ê°€ì¥ ì¤‘ìš”!)
                log("3. ë°ì´í„°ë² ì´ìŠ¤ ê¶Œí•œ í…ŒìŠ¤íŠ¸...");
                const testRef = db.collection('test_logs').doc('connection_check');
                try {
                    await testRef.set({ check: true, time: Date.now() });
                    log("âœ… DB ì“°ê¸° ì„±ê³µ (ê¶Œí•œ ìˆìŒ)");
                } catch(e) {
                    log("âŒ DB ì“°ê¸° ì‹¤íŒ¨! (ì´ê²Œ ì›ì¸ì…ë‹ˆë‹¤)");
                    log("ì—ëŸ¬ ë‚´ìš©: " + e.message);
                    if(e.code === 'permission-denied') {
                        log("ğŸ’¡ í•´ê²°ì±…: Firestore 'ê·œì¹™(Rules)' íƒ­ì—ì„œ ê¶Œí•œì„ í—ˆìš©í•´ì•¼ í•©ë‹ˆë‹¤.");
                    }
                    return; // ì—¬ê¸°ì„œ ì¤‘ë‹¨
                }

                // 4. ì‚¬ìš©ì ê³„ì • ì¡°íšŒ
                const id = document.getElementById('login-id').value;
                const pw = document.getElementById('login-pw').value;
                log(`4. ê³„ì • ì¡°íšŒ ì‹œë„ (ID: ${id})`);

                const q = await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('users')
                    .where('id', '==', id).where('pw', '==', pw).get();

                if (q.empty) {
                    log("âš ï¸ ì¡°íšŒ ê²°ê³¼ ì—†ìŒ (ê³„ì •ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŒ)");
                    log("-> ìë™ ìƒì„± ì‹œë„...");
                    
                    if(id === 'dark584') {
                        await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('users').add({
                            id: 'dark584', pw: 'Rufghs0423!!', name: 'ìµœê³  ê´€ë¦¬ì', role: 'super_admin', approved: true, siteId: 'all'
                        });
                        log("âœ… ê´€ë¦¬ì ê³„ì • ìƒì„± ì™„ë£Œ! ë‹¤ì‹œ ë²„íŠ¼ì„ ëˆŒëŸ¬ë³´ì„¸ìš”.");
                    } else {
                        log("âŒ ì¼ë°˜ ê³„ì •ì€ íšŒì›ê°€ì…ë¶€í„° í•˜ì„¸ìš”.");
                    }
                } else {
                    const userData = q.docs[0].data();
                    log(`ğŸ‰ ë¡œê·¸ì¸ ì„±ê³µ! ì´ë¦„: ${userData.name}`);
                    log("ê²°ë¡ : ì‹œìŠ¤í…œì€ ì •ìƒì…ë‹ˆë‹¤. ì›ë˜ ì½”ë“œë¡œ ë³µêµ¬í•´ë„ ë©ë‹ˆë‹¤.");
                }

            } catch (e) {
                log("ğŸš¨ ì¹˜ëª…ì  ì—ëŸ¬ ë°œìƒ!");
                log(e.message);
                if(e.message.includes("network")) log("ğŸ’¡ ì¸í„°ë„· ì—°ê²° ìƒíƒœë¥¼ í™•ì¸í•˜ì„¸ìš”.");
            }
        };
    </script>
</body>
</html>