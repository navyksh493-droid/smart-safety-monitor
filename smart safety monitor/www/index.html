// -----------------------------------------------------------
        // [ìˆ˜ì •ë¨] ë‚ ì”¨ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° + 1ì‹œê°„ ë‹¨ìœ„ DB ìë™ ì €ì¥ ê¸°ëŠ¥ ì¶”ê°€
        // -----------------------------------------------------------
        async function fetchWeather() {
            try {
                // ê°•ìˆ˜ëŸ‰(precipitation) ë°ì´í„°ë¥¼ ì–»ê¸° ìœ„í•´ API URLì„ ìµœì‹  ë²„ì „ìœ¼ë¡œ ìˆ˜ì •í•¨
                const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${SITE_CENTER.lat}&longitude=${SITE_CENTER.lng}&current=temperature_2m,precipitation,rain,weather_code,wind_speed_10m&timezone=auto`);
                const data = await res.json();
                
                if(data.current) {
                    const temp = data.current.temperature_2m;
                    const wind = data.current.wind_speed_10m;
                    const rain = data.current.precipitation || 0; // ê°•ìˆ˜ëŸ‰
                    
                    document.getElementById('weather-temp').innerText = `${temp}Â°C`;
                    document.getElementById('weather-wind').innerText = `${wind} m/s`;
                    
                    // ìœ„í—˜ ê°ì§€ ë¡œì§
                    if(temp >= 33) triggerHeatWave(true);
                    else if(temp <= -10) triggerColdWave(true);

                    // [ì¶”ê°€] ë‚ ì”¨ ë¡œê·¸ DB ì €ì¥ (1ì‹œê°„ì— 1ë²ˆë§Œ ì €ì¥ë˜ë„ë¡ ì²´í¬)
                    saveWeatherLog(temp, wind, rain);
                }
            } catch(e) { console.log('Weather fetch failed', e); }
        }

        // [ì‹ ê·œ] ë‚ ì”¨ ë¡œê·¸ ì €ì¥ í•¨ìˆ˜ (ì¤‘ë³µ ì €ì¥ ë°©ì§€ í¬í•¨)
        async function saveWeatherLog(temp, wind, rain) {
            const lastWeatherTime = parseInt(localStorage.getItem('lastWeatherLogTime') || '0');
            const now = Date.now();
            const oneHour = 3600000; 

            // ë§ˆì§€ë§‰ ì €ì¥ í›„ 1ì‹œê°„ì´ ì§€ë‚¬ì„ ë•Œë§Œ DBì— ì €ì¥
            if (now - lastWeatherTime > oneHour) {
                try {
                    // íŠ¹ì´ì‚¬í•­ íŒë³„
                    let condition = "ì¼ë°˜";
                    if(temp >= 33) condition = "í­ì—¼(ê²½ë³´/ì£¼ì˜)";
                    if(temp <= -10) condition = "í•œíŒŒ(ê²½ë³´/ì£¼ì˜)";
                    if(rain > 0) condition += `/ìš°ì²œ(${rain}mm)`;

                    await addDoc(getColRef('weather_logs'), {
                        time: now,
                        temp: temp,
                        wind: wind,
                        rain: rain,
                        condition: condition,
                        siteId: currentSiteId
                    });
                    localStorage.setItem('lastWeatherLogTime', now.toString());
                    console.log("ğŸŒ¦ï¸ ë‚ ì”¨ ë¡œê·¸ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
                } catch(e) { console.error("Weather log error", e); }
            }
        }

        // -----------------------------------------------------------
        // [ìˆ˜ì •ë¨] ì—‘ì…€ ë‹¤ìš´ë¡œë“œ (3ê°œ ì‹œíŠ¸ ë¶„í•  ì €ì¥)
        // -----------------------------------------------------------
        window.exportToExcel = async () => {
            if(!confirm("ëª¨ë“  ë°ì´í„°ë¥¼ ì§‘ê³„í•˜ì—¬ ì—‘ì…€ë¡œ ë³€í™˜í•©ë‹ˆë‹¤.\në°ì´í„° ì–‘ì— ë”°ë¼ ì‹œê°„ì´ ê±¸ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤.")) return;
            showToast("â³ ì—‘ì…€ ìƒì„± ì¤‘...", "notice");

            try {
                const wb = XLSX.utils.book_new();

                // ==========================================
                // 1. ì‹œíŠ¸: ê·¼ë¡œì ì¶œí‡´ê·¼ ê¸°ë¡ (Commute Logs)
                // ==========================================
                // DBì—ì„œ 'commute' íƒ€ì…ì˜ ë¡œê·¸ë§Œ ê°€ì ¸ì˜¤ê¸°
                let qCommute = query(getColRef('logs'), where('type', '==', 'commute'), orderBy('time', 'desc'));
                if(currentSiteId !== 'all') qCommute = query(getColRef('logs'), where('siteId', '==', 'commute'), where('siteId', '==', currentSiteId), orderBy('time', 'desc'));
                
                const commuteSnap = await getDocs(qCommute);
                const commuteData = [];
                
                // í†µê³„ ê³„ì‚°ì„ ìœ„í•œ ë°°ì—´
                const checkInTimes = [];
                const checkOutTimes = [];

                commuteSnap.forEach(doc => {
                    const d = doc.data();
                    const dateObj = new Date(d.time);
                    const dateStr = dateObj.toLocaleDateString();
                    const timeStr = dateObj.toLocaleTimeString();
                    
                    // í†µê³„ìš© ë°ì´í„° ìˆ˜ì§‘
                    const hour = dateObj.getHours();
                    if(d.msg.includes('ì¶œê·¼')) checkInTimes.push(hour);
                    if(d.msg.includes('í‡´ê·¼')) checkOutTimes.push(hour);

                    commuteData.push({
                        "ì¼ì": dateStr,
                        "ì‹œê°„": timeStr,
                        "í˜„ì¥ID": siteMap[d.siteId] || d.siteId,
                        "ë‚´ìš©": d.msg
                    });
                });
                
                if(commuteData.length === 0) commuteData.push({"ì•Œë¦¼": "ê¸°ë¡ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤."});
                const wsCommute = XLSX.utils.json_to_sheet(commuteData);
                // ì—´ ë„ˆë¹„ ì„¤ì •
                wsCommute['!cols'] = [{wch:12}, {wch:12}, {wch:15}, {wch:50}];
                XLSX.utils.book_append_sheet(wb, wsCommute, "ì¶œí‡´ê·¼ê¸°ë¡");


                // ==========================================
                // 2. ì‹œíŠ¸: ë‚ ì”¨ ê¸°ë¡ (Weather Logs)
                // ==========================================
                let qWeather = query(getColRef('weather_logs'), orderBy('time', 'desc'));
                if(currentSiteId !== 'all') qWeather = query(getColRef('weather_logs'), where('siteId', '==', currentSiteId), orderBy('time', 'desc'));

                const weatherSnap = await getDocs(qWeather);
                const weatherData = [];

                weatherSnap.forEach(doc => {
                    const d = doc.data();
                    weatherData.push({
                        "ì¼ì‹œ": new Date(d.time).toLocaleString(),
                        "ê¸°ì˜¨(Â°C)": d.temp,
                        "ê°•ìˆ˜ëŸ‰(mm)": d.rain,
                        "í’ì†(m/s)": d.wind,
                        "íŠ¹ì´ì‚¬í•­": d.condition
                    });
                });

                if(weatherData.length === 0) weatherData.push({"ì•Œë¦¼": "ì•„ì§ ê¸°ë¡ëœ ë‚ ì”¨ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. (1ì‹œê°„ ë‹¨ìœ„ ìë™ ì €ì¥ë¨)"});
                const wsWeather = XLSX.utils.json_to_sheet(weatherData);
                wsWeather['!cols'] = [{wch:22}, {wch:10}, {wch:12}, {wch:10}, {wch:30}];
                XLSX.utils.book_append_sheet(wb, wsWeather, "ë‚ ì”¨í™˜ê²½ê¸°ë¡");


                // ==========================================
                // 3. ì‹œíŠ¸: í†µí•© í†µê³„ (Statistics)
                // ==========================================
                // (1) ì§ì¢… í†µê³„ ê³„ì‚°
                const jobStats = {};
                activeWorkers.forEach(w => {
                    const job = w.job || 'ë¯¸ì§€ì •';
                    jobStats[job] = (jobStats[job] || 0) + 1;
                });

                // (2) í‰ê·  ì¶œí‡´ê·¼ ì‹œê°„ ê³„ì‚°
                const avgIn = checkInTimes.length > 0 ? Math.round(checkInTimes.reduce((a,b)=>a+b,0)/checkInTimes.length) : 0;
                const avgOut = checkOutTimes.length > 0 ? Math.round(checkOutTimes.reduce((a,b)=>a+b,0)/checkOutTimes.length) : 0;

                // ì—‘ì…€ì— ë„£ì„ í¬ë§·ìœ¼ë¡œ ë³€í™˜
                const statsData = [
                    { "êµ¬ë¶„": "[ì¸ì› í˜„í™©]", "ê°’": "" },
                    { "êµ¬ë¶„": "í˜„ì¬ ì´ ì¸ì›", "ê°’": `${activeWorkers.length}ëª…` },
                    ...Object.keys(jobStats).map(job => ({ "êµ¬ë¶„": ` - ì§ì¢…: ${job}`, "ê°’": `${jobStats[job]}ëª…` })),
                    { "êµ¬ë¶„": "", "ê°’": "" }, // ë¹ˆ ì¤„
                    { "êµ¬ë¶„": "[ì¶œí‡´ê·¼ í†µê³„ (í‰ê· )]", "ê°’": "" },
                    { "êµ¬ë¶„": "í‰ê·  ì¶œê·¼ ì‹œê°„", "ê°’": avgIn > 0 ? `${avgIn}ì‹œ ê²½` : "ë°ì´í„° ë¶€ì¡±" },
                    { "êµ¬ë¶„": "í‰ê·  í‡´ê·¼ ì‹œê°„", "ê°’": avgOut > 0 ? `${avgOut}ì‹œ ê²½` : "ë°ì´í„° ë¶€ì¡±" },
                ];

                const wsStats = XLSX.utils.json_to_sheet(statsData);
                wsStats['!cols'] = [{wch:30}, {wch:20}];
                XLSX.utils.book_append_sheet(wb, wsStats, "ì¢…í•©í†µê³„");

                // íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì‹¤í–‰
                const fileName = `ì•ˆì „ê´€ì œ_ë¦¬í¬íŠ¸_${new Date().toISOString().slice(0,10)}.xlsx`;
                XLSX.writeFile(wb, fileName);
                showToast("âœ… ì—‘ì…€ ì €ì¥ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.", "success");

            } catch(e) {
                console.error(e);
                alert("ì—‘ì…€ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + e.message);
            }
        };